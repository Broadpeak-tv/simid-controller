"use strict";!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("analyticsSmartLibModule",[],e):"object"==typeof exports?exports.analyticsSmartLibModule=e():t.analyticsSmartLibModule=e()}("undefined"!=typeof self?self:global,(function(){return(("undefined"!=typeof self?self:global).webpackChunkSmartLibModule=("undefined"!=typeof self?self:global).webpackChunkSmartLibModule||[]).push([[153],{4404:function(t,e,a){a.d(e,{A:function(){return s}});class s{static hasMethods(t,e){let a=!0;return void 0!==t&&(e.forEach((e=>{"function"!=typeof t[e]&&(a=!1)})),a)}static count(t,e){let a=0;for(const s in t){!0===e(s,t[s])&&a++}return a}}},5207:function(t,e,a){a.d(e,{bW:function(){return f},Bw:function(){return j},_7:function(){return G},sX:function(){return Y},Go:function(){return X},qT:function(){return h},NQ:function(){return m},K1:function(){return A},pi:function(){return P},nm:function(){return n},Wy:function(){return d},dx:function(){return p},lX:function(){return U},c5:function(){return w},EC:function(){return W}});var s=a(8379),i=a(3473);const r="BpkPlayerAdapter";class n{handler;webOSVersion;constructor(){"undefined"!=typeof webOS&&webOS.deviceInfo((t=>{this.webOSVersion=t.sdkVersion}))}getName(){return""}getVersion(){return""}getOSName(){return i.A.getInstance().osName}getOSVersion(){return i.A.getInstance().osVersion}getDeviceType(){return i.A.getInstance().deviceType}getBitrate(){return-1}getPosition(){return 0}getDuration(){return 0}getVolume(){return 1}getCapabilities(){return{adTracking:!1}}initSessionPlayerObjects(){}releaseSessionPlayerObjects(){}initDiversityPlugin(t,e){}initDiversitySession(t){}setDiversityManifest(t){}releaseDiversitySession(){}fillSessionReport(t){t.playerName=this.getName(),t.playerVersion=this.getVersion(),t.osName=this.getOSName(),t.osVersion=this.getOSVersion(),t.deviceType=this.getDeviceType()}onStart(){const t=this.handler.sessionReport;this.fillSessionReport(t)}onKeepaliveSessionReportUpdateRequested(t){this.fillSessionReport(t)}onEndSessionReportUpdateRequested(t){this.fillSessionReport(t)}notifyLoading(){void 0!==this.handler?this.handler.notifyLoading():s.g.e(r,"Implementation error: session.attachPlayer should be called prior to onLoading event. This event is called when the player starts buffering the first time.")}notifyPrecacheEnded(){void 0!==this.handler?this.handler.notifyPrecacheEnded():s.g.e(r,"Implementation error: session.attachPlayer should be called prior to onPrecachedEnded event. This event is called when the player starts buffering chunks.")}notifyFirstImage(){void 0!==this.handler?this.handler.notifyFirstImage(this.getBitrate(),this.getPosition()):s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onSessionStart event. This event is called when the first image is displayed.")}notifyPause(){void 0!==this.handler?this.handler.notifyPause():s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onSessionPause event.")}notifyResume(){void 0!==this.handler?this.handler.notifyResume():s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onSessionResume event.")}notifyLayerSwitch(t=this.getBitrate()){void 0!==this.handler?this.handler.notifyLayerSwitch(t):s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onLayerSwitch event.")}notifySeek(t,e){void 0!==this.handler?this.handler.notifySeek(t,e):s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onSeek event.")}notifyStallStart(){void 0!==this.handler?this.handler.notifyBufferingStart():s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onStallStart event.")}notifyStallEnd(t=!0){void 0!==this.handler?this.handler.notifyBufferingEnd(t):s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onStallEnd event.")}notifyClose(t=void 0){void 0!==this.handler?this.handler.notifyClose(t):s.g.e(r,"Implementation error: session.attachPlayer should be called prior to onSessionStart event. This event is called when the player is closing.")}notifyVolumeChanged(t){void 0!==this.handler?this.handler.notifyVolumeChanged(t):s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onVolumeChanged event.")}notifyPlayerError(t,e){void 0!==this.handler?this.handler.notifyPlayerError(t,e):s.g.e(r,"Implementation error: session.getURL(...) or session.getQuery()/session.startStreamingSession(...) should be called prior to onPlayerError event.")}static checkPlayer(t,e){return s.g.e(r,"Implementation error: static checkPlayer not implemented for this adapter."),!1}attachPlayer(t,e){return s.g.e(r,"Implementation error: attachPlayer not implemented for this adapter."),!1}detachPlayer(){s.g.e(r,"Implementation error: detachPlayer not implemented for this adapter.")}attachSession(t){this.handler=t}detachSession(){this.handler=void 0}setStatusCode(t){void 0!==this.handler&&(this.handler.sessionReport.statusCode=t)}setPlayerErrorCode(t){void 0!==this.handler&&(this.handler.sessionReport.playerErrorCode=String(t))}setCustomParameter(t,e){void 0!==this.handler&&(void 0===this.handler.streamingSession?s.g.e(r,"Set custom parameter on player adapter is only available when using StreamingSession API.",this.handler.id):this.handler.streamingSession.setCustomParameter(t,e))}}var o=a(4404);class h extends n{player;listener;constructor(){super()}getName(){return this.player.getPlayerName()}getVersion(){return this.player.getVersion()}getOSName(){return this.player.getOSName()}getOSVersion(){return this.player.getDeviceVersion()}getDeviceType(){return this.player.getDeviceType()}getBitrate(){return this.player.getCurrentBitrate()}getPosition(){return this.player.getCurrentPosition()}getDuration(){return this.player.getTotalDuration()}getCapabilities(){return"function"==typeof this.player.getCapabilities?this.player.getCapabilities():super.getCapabilities()}static checkPlayer(t,e){return o.A.hasMethods(t,["getPlayerName","getVersion","getOSName","getDeviceVersion","getDeviceType","getCurrentPosition","getTotalDuration","getCurrentBitrate"])}initDiversitySession(t){return this.player.initDiversitySession(t)}attachPlayer(t,e){return!!h.checkPlayer(t,e)&&(this.player=t,this.listener=e,this.player.playerAdapter=this,!0)}detachPlayer(){void 0!==this.player&&(this.player.playerAdapter=void 0),this.player=void 0,this.listener=void 0}}const l="BpkPlayerEventListener";class d{static playerAdapters=[];static addPlayerAdapter(t){-1===d.playerAdapters.indexOf(t)&&d.playerAdapters.push(t)}static removePlayerAdapter(t){let e=d.playerAdapters.indexOf(t);-1!==e&&d.playerAdapters.splice(e,1)}static isStarted(){const t=d.playerAdapters;return t.length>0&&(void 0!==t[t.length-1].handler&&t[t.length-1].handler.metricsManager.started)}static isPlaying(){const t=d.playerAdapters;return t.length>0&&(void 0!==t[t.length-1].handler&&t[t.length-1].handler.metricsManager.playing)}static isBuffering(){const t=d.playerAdapters;return t.length>0&&(void 0!==t[t.length-1].handler&&t[t.length-1].handler.metricsManager.buffering)}static onSessionStart(){const t=d.playerAdapters;t.length>0?t.forEach((t=>t.notifyFirstImage())):s.g.e(l,"Implementation error: SmartLib.attachPlayer(...) should be called prior to onSessionStart event. If you don't attach any player, please remove this call, SmartLib is now handling it automatically.")}static onSessionPause(){const t=d.playerAdapters;t.length>0?t.forEach((t=>t.notifyPause())):s.g.e(l,"Implementation error: SmartLib.attachPlayer(...) should be called prior to onSessionPause event.")}static onSessionResume(){const t=d.playerAdapters;t.length>0?t.forEach((t=>t.notifyResume())):s.g.e(l,"Implementation error: SmartLib.attachPlayer(...) should be called prior to onSessionResume event.")}static onLayerSwitch(t){const e=d.playerAdapters;e.length>0?e.forEach((e=>e.notifyLayerSwitch(t))):s.g.e(l,"Implementation error: SmartLib.attachPlayer(...) should be called prior to onLayerSwitch event.")}static onSeek(t,e){const a=d.playerAdapters;a.length>0?a.forEach((a=>a.notifySeek(t,e))):s.g.e(l,"Implementation error: SmartLib.attachPlayer(...) should be called prior to onSeek event.")}static onStallStart(){const t=d.playerAdapters;t.length>0?t.forEach((t=>t.notifyStallStart())):s.g.e(l,"Implementation error: SmartLib.attachPlayer(...) should be called prior to onStallStart event.")}static onStallEnd(t){const e=d.playerAdapters;e.length>0?e.forEach((e=>e.notifyStallEnd(t))):s.g.e(l,"Implementation error: SmartLib.attachPlayer(...) should be called prior to onStallEnd event.")}}const c="BpkPlayerMgr";class u{static loadPlayerAdapters(){return{}}}class p{static#t;smartLib;#e=u;#a={};#s;static getInstance(){return p.#t||(p.#t=new p),p.#t}init(t){this.#e===u&&(this.#e=t,this.#a=this.#e.loadPlayerAdapters(),s.g.v(c,"Compatible players: "+Object.keys(this.#a)))}release(){this.setPlayerAdapter(void 0)}attachInstance(t){this.smartLib=t}getAdapters(){return this.#a}setPlayerAdapter(t){void 0!==this.#s&&this.#s!==t&&(s.g.i(c,"Player "+this.#s.getName()+" detached"),this.#s.detachPlayer()),this.#s!==t&&void 0!==t?t instanceof h&&(s.g.d(c,"Attaching generic player to SmartLib singleton"),d.addPlayerAdapter(t)):this.#s!==t&&void 0===t&&this.#s instanceof h&&(s.g.d(c,"Detaching generic player from SmartLib singleton"),d.removePlayerAdapter(this.#s)),this.#s!==t?this.#s=t:void 0!==t&&s.g.i(c,"Player "+this.#s.getName()+" already attached"),void 0!==t&&s.g.i(c,"Player "+t.getName()+" attached")}getPlayerAdapter(){return this.#s}}const g="BpkGenericPlayerApi";class m{playerAdapter;constructor(){}getPlayerName(){return""}getVersion(){return""}getOSName(){return""}getDeviceVersion(){return""}getDeviceType(){return""}getCurrentPosition(){return 0}getTotalDuration(){return 0}getCurrentBitrate(){return 0}getCapabilities(){return{}}notifyPrecacheEnded(){void 0!==this.playerAdapter?this.playerAdapter.notifyPrecacheEnded():s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifyPrecacheEnded. This event is called when the player starts buffering chunks.")}notifyFirstImage(){void 0!==this.playerAdapter?this.playerAdapter.notifyFirstImage():s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifyFirstImage. This event is called when the first image is displayed.")}notifyPause(){void 0!==this.playerAdapter?this.playerAdapter.notifyPause():s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifyPause.")}notifyResume(){void 0!==this.playerAdapter?this.playerAdapter.notifyResume():s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifyResume.")}notifyLayerSwitch(t){void 0!==this.playerAdapter?this.playerAdapter.notifyLayerSwitch(t):s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifyLayerSwitch.")}notifyStallStart(){void 0!==this.playerAdapter?this.playerAdapter.notifyStallStart():s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifyStallStart.")}notifyStallEnd(t){void 0!==this.playerAdapter?this.playerAdapter.notifyStallEnd(t):s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifyStallEnd.")}notifySeek(t,e){void 0!==this.playerAdapter?this.playerAdapter.notifySeek(t,e):s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to notifySeek.")}setPlayerErrorCode(t){void 0!==this.playerAdapter?this.playerAdapter.setPlayerErrorCode(t):s.g.e(g,"Implementation error: session.attachPlayer(...) should be called prior to setPlayerErrorCode. This has to be called before stopStreamingSession when the player error code as a string.")}}var v=a(1134),S=a(1142);const y="BpkAnalyticsRequestMgr";class f{static METRICS_RECEIVER_PATH="fservices/metricsReceiver";static POST_SESSION_REQUEST_TIMEOUT=5e3;static NOCACHE_PREFIX="nocache=";static#t;static getInstance(){return f.#t||(f.#t=new f),f.#t}buildAnalyticsAddress(t){return(t=t.trim()).endsWith("/")||(t+="/"),t+=f.METRICS_RECEIVER_PATH}endSession(t,e){const a=t.sessionReport;if(0!==e.analyticsAddress.length){const i=e.analyticsAddress.split(",");let r=[];return i.forEach((i=>{let n;0===i.indexOf(f.NOCACHE_PREFIX)?(s.g.d(y,f.NOCACHE_PREFIX+" option used, no need to store the report in cache"),i=this.buildAnalyticsAddress(i.substring(f.NOCACHE_PREFIX.length))):(i=this.buildAnalyticsAddress(i),n=S.A.analyticsModule.CacheManager.getInstance().storeSessionReport(i,a.toEndSessionJSON(),!0,Date.now(),!0)),s.g.i(y,"Posting metrics to "+i,t.id);const o=this.postSession(i,a.toEndSessionJSON(),e).then((e=>(s.g.i(y,"Send session metrics ended with status code "+e.httpStatus+" ("+i+")",t.id),e.httpStatus>=200&&e.httpStatus<300?(void 0!==n&&S.A.analyticsModule.CacheManager.getInstance().deleteSessionReport(n),S.A.analyticsModule.CacheManager.getInstance().push(),!0):(void 0!==n&&S.A.analyticsModule.CacheManager.getInstance().update(n,"sending",!1),!1))));r.push(o)})),Promise.all(r).then((()=>{s.g.d(y,"Send session metrics done",t.id)}))}return s.g.w(y,"Metrics platform URL is null, metrics won't be posted anywhere.",t.id),Promise.resolve(!1)}endSessionCache(t,e,a){return 0!==t.length?(s.g.i(y,"Posting cache to "+t),this.postSession(t,e,a).then((e=>(s.g.i(y,"Send cache ended with status code "+e.httpStatus+" ("+t+")"),e.httpStatus>=200&&e.httpStatus<300)))):(s.g.w(y,"Metrics platform URL is null, cache won't be posted anywhere."),Promise.resolve(!1))}postSession(t,e,a){return new Promise(((i,r)=>{let n={Connection:"close"};void 0!==a.userAgent&&(n["User-Agent"]=a.userAgent);let o=JSON.stringify(e);s.g.v(y,"Executing POST request with body: "+o),v.A.getInstance().asyncPost(t,n,o,f.POST_SESSION_REQUEST_TIMEOUT,(t=>{let e=0;void 0!==t.statusCode&&(e=parseInt(t.statusCode,10)),i({httpStatus:e})}))}))}}var E=a(4943);class b{static EMPTY=new this(0);index;buffer;constructor(t){this.index=0,this.buffer=new Uint8Array(t)}put(t){return this.buffer[this.index++]=t,this}putChar(t){return this.buffer[this.index++]=(65280&t)>>8,this.buffer[this.index++]=255&t,this}putByteBuffer(t,e=t.buffer.length){const a=t.buffer;return this.buffer.length>=this.index+e&&(this.buffer.set(a,this.index),this.index+=e),this}set(t,e){return this.buffer[e]=t,this}data(){return this.buffer}base64(){return E.A.bufferToBase64(this)}length(){return this.index}capacity(){return this.buffer.length}remaining(){return this.capacity()-this.length()}toString(){return E.A.bufferToString(this.buffer,this.index)+"(length:"+this.length()+")"}}var D=a(3445);class A{static PLAYBACK_TYPE_LIVE="LIVE";static PLAYBACK_TYPE_VOD="VOD";redirectionTime;startupTime;completion;playbackType;playbackDuration;sessionDuration;contentDuration;stallsNumber;maxStallDuration;totalStallsDuration;rebufferingsNumber;maxRebufferingDuration;totalRebufferingDuration;minBitrate;maxBitrate;averageBitrate;layerSwitchesNumber;timeSpentPerLayer;preStartupTime;constructor(t){void 0!==t?(this.redirectionTime=t.redirectionTime,this.startupTime=t.startupTime,this.completion=t.completion,this.playbackType=t.playbackType,this.playbackDuration=t.playbackDuration,this.sessionDuration=t.sessionDuration,this.contentDuration=t.contentDuration,this.stallsNumber=t.stallsNumber,this.maxStallDuration=t.maxStallDuration,this.totalStallsDuration=t.totalStallsDuration,this.rebufferingsNumber=t.rebufferingsNumber,this.maxRebufferingDuration=t.maxRebufferingDuration,this.totalRebufferingDuration=t.totalRebufferingDuration,this.minBitrate=t.minBitrate,this.maxBitrate=t.maxBitrate,this.averageBitrate=t.averageBitrate,this.layerSwitchesNumber=t.layerSwitchesNumber,this.timeSpentPerLayer=JSON.parse(JSON.stringify(t.timeSpentPerLayer)),this.preStartupTime=t.preStartupTime):(this.redirectionTime=0,this.startupTime=0,this.completion=0,this.playbackType="",this.playbackDuration=0,this.sessionDuration=0,this.contentDuration=0,this.stallsNumber=0,this.maxStallDuration=0,this.totalStallsDuration=0,this.rebufferingsNumber=0,this.maxRebufferingDuration=0,this.totalRebufferingDuration=0,this.minBitrate=0,this.maxBitrate=0,this.averageBitrate=0,this.layerSwitchesNumber=0,this.timeSpentPerLayer={},this.preStartupTime=0)}}class k{metrics;watchingRanges;constructor(t=new A){this.metrics=t,this.reset()}setRedirectionTime(t){return this.metrics.redirectionTime=t,this}setStartupTime(t){return this.metrics.startupTime=t,this}setSessionDuration(t){return this.metrics.sessionDuration=t,this}setContentDuration(t){return this.metrics.contentDuration=t,this}setPlaybackType(t){return this.metrics.playbackType=t,this}setFirstLayer(t){return t>0&&(this.metrics.maxBitrate=t,this.metrics.minBitrate=t),this}setPreStartupTime(t){return this.metrics.preStartupTime=t,this}addTimeSpentPerLayer(t,e){if((t=Math.round(t))>0){let a=this.metrics.timeSpentPerLayer[t];void 0===a&&(a=0),a+=e,this.metrics.timeSpentPerLayer[t]=a,this.metrics.maxBitrate<t&&(this.metrics.maxBitrate=t),(this.metrics.minBitrate>t||0===this.metrics.minBitrate)&&(this.metrics.minBitrate=t)}return this}addLayerSwitch(){return this.metrics.layerSwitchesNumber++,this}addPlaybackDuration(t){return this.metrics.playbackDuration+=t,this}addWatchingRange(t,e){return t<e&&(s.g.v("BpkMetrics","Add watching range, duration "+(e-t)+"ms"),this.watchingRanges.push({start:t,end:e,duration:e-t})),this}addStall(t){return this.metrics.stallsNumber++,this.metrics.totalStallsDuration+=t,this.metrics.maxStallDuration<t&&(this.metrics.maxStallDuration=t),this}addRebuffering(t){return this.metrics.rebufferingsNumber++,this.metrics.totalRebufferingDuration+=t,this.metrics.maxRebufferingDuration<t&&(this.metrics.maxRebufferingDuration=t),this}clone(){const t=new k(new A(this.metrics));return t.watchingRanges=JSON.parse(JSON.stringify(this.watchingRanges)),t}computeCompletion(){if(this.metrics.playbackType===A.PLAYBACK_TYPE_LIVE||0===this.metrics.contentDuration)return 1e3;const t=JSON.parse(JSON.stringify(this.watchingRanges));let e=t.slice(0);if(1===t.length)return Math.floor(1e3*e[0].duration/this.metrics.contentDuration);if(0===t.length)return 0;const a=[];let s=null;e=e.sort(((t,e)=>parseInt(t.start,10)>parseInt(e.start,10)?1:parseInt(t.start,10)<parseInt(e.start,10)?-1:0)),a.push(e[0]);for(let t=1;t<e.length;t++)s=a[a.length-1],parseInt(s.end,10)<parseInt(e[t].start,10)?a.push(e[t]):parseInt(s.end,10)<parseInt(e[t].end,10)&&(s.end=parseInt(e[t].end,10),s.duration=s.end-s.start,a.pop(),a.push(s));let i=0;for(let t=0;t<a.length;t++)a[t].duration=parseInt(a[t].end,10)-parseInt(a[t].start,10),i+=parseInt(a[t].duration,10);this.watchingRanges=a;let r=Math.floor(1e3*i/this.metrics.contentDuration);return r>1e3?1e3:r}build(){let t=0,e=0;for(let a in this.metrics.timeSpentPerLayer){const s=this.metrics.timeSpentPerLayer[a];t+=a*s,e+=s}return 0!==e&&(this.metrics.averageBitrate=Math.round(t/e)),this.metrics.completion=this.computeCompletion(),this.metrics.completion<0?this.metrics.completion=0:this.metrics.completion>1e3&&(this.metrics.completion=1e3),this.metrics.startupTime+=this.metrics.preStartupTime,this.metrics}reset(){return this.watchingRanges=[],this}}const I="BpkMetricsMgr";class P{static MAX_TIME_BETWEEN_SEEK_AND_REBUFFERING=1e3;handler;builder;playerAdapter;timeline;started;playing;buffering;seeking;bitrate;redirectionStartDate;playingStartDate;bufferingStartDate;lastLayerSwitchDate;lastSeekDate;playOnNextBufferingEnd;startPosition;constructor(t,e){this.handler=t,this.builder=new k,this.playerAdapter=e,this.timeline=this.handler.sessionReport.timeline,this.started=!1,this.playing=!1,this.buffering=!1,this.seeking=!1,this.bitrate=-1,this.redirectionStartDate=Date.now(),this.playingStartDate=Date.now(),this.bufferingStartDate=0,this.lastLayerSwitchDate=0,this.lastSeekDate=0,this.playOnNextBufferingEnd=!1,this.startPosition=0}onStart(){this.redirectionStartDate=Date.now()}onRedirectionEnd(){this.builder.setRedirectionTime(Date.now()-this.redirectionStartDate),this.playingStartDate=Date.now()}onPrecacheEnded(){this.playingStartDate=Date.now()}onFirstImage(t,e){s.g.i(I,"Streaming session started ("+t+"kbps,"+D.A.formatTime(e)+")",this.handler.id),this.started=!0,this.playing=!0,this.startPosition=e,this.builder.setContentDuration(this.playerAdapter.getDuration()).setPlaybackType(this.playerAdapter.getDuration()<=0?A.PLAYBACK_TYPE_LIVE:A.PLAYBACK_TYPE_VOD),this.builder.setStartupTime(Date.now()-this.redirectionStartDate),this.playingStartDate=Date.now(),this.builder.setFirstLayer(t),this.bitrate=t,this.lastLayerSwitchDate=Date.now()}onLayerSwitch(t){s.g.d(I,"Player changed layer to "+t+"kbps",this.handler.id),this.started&&(this.builder.addTimeSpentPerLayer(this.bitrate,Date.now()-this.lastLayerSwitchDate),this.lastLayerSwitchDate=Date.now(),this.bitrate!==t&&this.bitrate>0&&(s.g.d(I,"Player changed layer, before: "+this.bitrate+"kbps, now: "+t+"kbps",this.handler.id),this.timeline?.pushEventBitrate(w.LayerSwitch,t),this.builder.addLayerSwitch())),this.bitrate=t}onPause(){this.playing&&(s.g.d(I,"Player is paused",this.handler.id),this.timeline?.pushEvent(w.Pause),this.playing=!1,this.buffering||this.builder.addPlaybackDuration(Date.now()-this.playingStartDate),this.builder.addWatchingRange(this.startPosition,this.playerAdapter.getPosition()))}onResume(){this.started&&!this.playing&&(s.g.d(I,"Player is resumed",this.handler.id),this.timeline?.pushEvent(w.Resume),this.playing=!0,this.buffering=!1,this.playingStartDate=Date.now())}onBufferingStart(){if(!this.buffering&&this.started){s.g.d(I,"Player is buffering",this.handler.id),this.timeline?.pushEvent(w.BufferingStart);const t=Date.now();this.buffering=!0,this.seeking&&t-this.lastSeekDate>P.MAX_TIME_BETWEEN_SEEK_AND_REBUFFERING&&(this.seeking=!1),this.bufferingStartDate=t,this.playOnNextBufferingEnd=!1,this.playing&&this.builder.addPlaybackDuration(t-this.playingStartDate)}}onBufferingEnd(t){const e=Date.now();t&&this.playOnNextBufferingEnd&&!this.buffering&&(this.playingStartDate=e,this.playOnNextBufferingEnd=!1),this.started&&this.bufferingStartDate>0&&(this.buffering=!1,t?this.playingStartDate=e:this.playOnNextBufferingEnd=!0,this.seeking?(this.seeking=!1,this.handler.notifyRebufferingEnd()):this.handler.notifyStallEnd(),this.bufferingStartDate=0)}onStallEnd(){const t=Date.now()-this.bufferingStartDate;this.builder.addStall(t),this.timeline?.pushEvent(w.StallStop),s.g.d(I,"Player stalled for "+t+"ms",this.handler.id)}onRebufferingEnd(){const t=Date.now()-this.bufferingStartDate;this.builder.addRebuffering(t),this.timeline?.pushEvent(w.RebufferingStop),s.g.d(I,"Player buffered for "+t+"ms",this.handler.id)}onSeek(t,e){s.g.d(I,"Player seeked from "+D.A.formatTime(t)+" to "+D.A.formatTime(e),this.handler.id),this.timeline?.pushEventPositionStartEnd(w.Seek,t,e),this.builder.addWatchingRange(this.startPosition,t),this.startPosition=e,this.seeking=!0,this.lastSeekDate=Date.now()}onStop(t){if(this.started){const t=Date.now();this.playing&&!this.buffering&&this.builder.addPlaybackDuration(t-this.playingStartDate),this.buffering&&this.onBufferingEnd(!1),this.playing&&(this.builder.addWatchingRange(this.startPosition,this.playerAdapter.getPosition()),this.playing=!1),this.builder.setSessionDuration(t-this.redirectionStartDate).addTimeSpentPerLayer(this.bitrate,t-this.lastLayerSwitchDate),this.started=!1}}onStartSessionReportUpdateRequested(t){t.metrics=this.builder.build()}onKeepaliveSessionReportUpdateRequested(t){const e=Date.now(),a=this.builder.clone();if(this.playing&&!this.buffering&&a.addPlaybackDuration(e-this.playingStartDate),this.started&&this.bufferingStartDate>0){const t=Date.now()-this.bufferingStartDate;this.seeking?a.addRebuffering(t):a.addStall(t)}this.playing&&a.addWatchingRange(this.startPosition,this.playerAdapter.getPosition()),a.setSessionDuration(e-this.redirectionStartDate).addTimeSpentPerLayer(this.bitrate,e-this.lastLayerSwitchDate);const s=this.handler.getCustomParameters().pre_startup_time;let i=0;void 0===s||isNaN(s)||(i=parseInt(s,10)),a.setPreStartupTime(i),t.metrics=a.build()}onEndSessionReportUpdateRequested(t){const e=Date.now();this.builder.setSessionDuration(e-this.redirectionStartDate);const a=this.handler.getCustomParameters().pre_startup_time;let s=0;void 0===a||isNaN(a)||(s=parseInt(a,10)),this.builder.setPreStartupTime(s),t.metrics=this.builder.build()}}const w={None:0,Start:1,Stop:2,RedirectionEnd:3,FirstImage:4,Pause:5,Resume:6,BufferingStart:7,StallStart:8,StallStop:9,RebufferingStart:10,RebufferingStop:11,Seek:12,LayerSwitch:13,AdBreakStart:14,AdBreakStop:15,NetworkAvailable:16,NetworkLost:17,Mute:18,Unmute:19,Multicast:20,Unicast:21,PrecacheEnded:22,DataSummary:144,EmptySummary:145},N=[w.RedirectionEnd,w.Pause,w.Resume,w.BufferingStart,w.StallStart,w.StallStop,w.RebufferingStart,w.RebufferingStop,w.AdBreakStart,w.NetworkLost,w.Mute,w.Unmute,w.Multicast,w.Unicast,w.PrecacheEnded],R=[w.Start],B=[w.LayerSwitch],M=[w.FirstImage],T=[w.Seek],L=[w.Stop],C=[w.AdBreakStop],x=[w.NetworkAvailable],_="BpkSessionTrackerEvent";class U{eventId;eventDate;eventData;startStopEvent;startEventId;stopEventId;triggerStartEventId;keepLastOnly;attachEventId;attachMaxDurationBeforeStart;startEvent;stopEvent;attachedEvent;compressed;compressedData;constructor(t){this.eventId=t,this.eventDate=Date.now(),this.eventData={},this.startStopEvent=!1,this.startEventId=0,this.stopEventId=0,this.triggerStartEventId=0,this.keepLastOnly=!1,this.attachEventId=0,this.attachMaxDurationBeforeStart=-1,this.startEvent=null,this.stopEvent=null,this.attachedEvent=null,this.addDataSizeInTimeline=!1,this.compressed=!1,this.compressedData=void 0,this.updateMetadata()}updateMetadata(){switch(this.startStopEvent=!1,this.startEventId=w.None,this.stopEventId=w.None,this.triggerStartEventId=w.None,this.keepLastOnly=!1,this.attachEventId=w.None,this.attachMaxDurationBeforeStart=-1,this.eventId){case w.None:break;case w.Start:this.startStopEvent=!0,this.startEventId=w.Start,this.stopEventId=w.Stop,this.addDataSizeInTimeline=!0;break;case w.Stop:this.startStopEvent=!0,this.startEventId=w.Start,this.stopEventId=w.Stop;break;case w.RedirectionEnd:this.startStopEvent=!1,this.attachEventId=w.Start;break;case w.FirstImage:this.startStopEvent=!1,this.keepLastOnly=!0,this.attachEventId=w.RedirectionEnd;break;case w.Pause:case w.Resume:this.startStopEvent=!0,this.startEventId=w.Pause,this.stopEventId=w.Resume;break;case w.StallStart:this.startStopEvent=!0,this.startEventId=w.StallStart,this.stopEventId=w.StallStop;break;case w.StallStop:this.startStopEvent=!0,this.startEventId=w.StallStart,this.stopEventId=w.StallStop,this.triggerStartEventId=w.BufferingStart;break;case w.RebufferingStart:this.startStopEvent=!0,this.startEventId=w.RebufferingStart,this.stopEventId=w.RebufferingStop;break;case w.RebufferingStop:this.startStopEvent=!0,this.startEventId=w.RebufferingStart,this.stopEventId=w.RebufferingStop,this.triggerStartEventId=w.BufferingStart,this.attachEventId=w.Seek,this.attachMaxDurationBeforeStart=P.MAX_TIME_BETWEEN_SEEK_AND_REBUFFERING;break;case w.AdBreakStart:this.startStopEvent=!0,this.startEventId=w.AdBreakStart,this.stopEventId=w.AdBreakStop;break;case w.AdBreakStop:this.startStopEvent=!0,this.startEventId=w.AdBreakStart,this.stopEventId=w.AdBreakStop,this.attachEventId=w.Seek,this.attachMaxDurationBeforeStart=0;break;case w.BufferingStart:case w.Seek:case w.LayerSwitch:case w.NetworkAvailable:case w.NetworkLost:this.startStopEvent=!1;break;case w.Mute:case w.Unmute:case w.Multicast:case w.Unicast:case w.PrecacheEnded:this.startStopEvent=!1,this.addDataSizeInTimeline=!0}}getEventName(){switch(this.eventId){case w.None:return"None";case w.Start:return"Start";case w.Stop:return"Stop";case w.RedirectionEnd:return"RedirectionEnd";case w.FirstImage:return"FirstImage";case w.Pause:return"Pause";case w.Resume:return"Resume";case w.BufferingStart:return"BufferingStart";case w.StallStart:return"StallStart";case w.StallStop:return"StallStop";case w.RebufferingStart:return"RebufferingStart";case w.RebufferingStop:return"RebufferingStop";case w.Seek:return"Seek";case w.LayerSwitch:return"LayerSwitch";case w.AdBreakStart:return"AdBreakStart";case w.AdBreakStop:return"AdBreakStop";case w.NetworkAvailable:return"NetworkAvailable";case w.NetworkLost:return"NetworkLost";case w.Mute:return"Mute";case w.Unmute:return"Unmute";case w.Multicast:return"Multicast";case w.Unicast:return"Unicast";case w.PrecacheEnded:return"PrecacheEnded"}return""}isStartEvent(){return this.startStopEvent&&this.eventId===this.startEventId}isStopEvent(){return this.startStopEvent&&this.eventId===this.stopEventId}addEventData(t,e){"string"==typeof t&&(this.eventData[t]=e)}toData(t){const e=Math.abs(this.eventDate-t)/100,a=E.A.floor(e/65535),s=e%65535,i=Object.keys(this.eventData).length;let r=3*a+1+2+2*i+(this.addDataSizeInTimeline?1:0),n=new b(r);for(let t=0;t<a;t++)n.put(w.None),n.put(255),n.put(255);switch(n.put(this.eventId),n.putChar(s),this.addDataSizeInTimeline&&n.put(2*i),this.eventId){case w.Start:{const t=parseInt(this.eventData.networkType,10),e=parseInt(this.eventData.muteState,10);n.putChar(t),n.putChar(e)}break;case w.Stop:{const t=parseInt(this.eventData.statusCode,10);n.putChar(t)}break;case w.FirstImage:{const t=parseInt(this.eventData.bitrate,10),e=parseInt(this.eventData.position,10);n.putChar(t),n.putChar(e)}break;case w.Seek:{const t=parseInt(this.eventData.positionStart,10),e=parseInt(this.eventData.positionEnd,10);n.putChar(t),n.putChar(e)}break;case w.LayerSwitch:{const t=parseInt(this.eventData.bitrate,10);n.putChar(t)}break;case w.AdBreakStop:{const t=parseInt(this.eventData.progress,10);n.putChar(t)}break;case w.NetworkAvailable:{const t=parseInt(this.eventData.state,10);n.putChar(t)}}return n}formatDate(t){return D.A.formatDate(new Date(t))}print(){s.g.v(_,"   |"),s.g.v(_,"   ├--\x3e "+this.getEventName()+" -> "+(!0===this.compressed?"compressed":"not compressed")+" -> "+this.eventDate),s.g.v(_,"   |      date: "+this.formatDate(this.eventDate));for(let t in this.eventData)s.g.v(_,"   |      "+t+": "+this.eventData[t]);this.isStartEvent()&&null!==this.stopEvent&&s.g.v(_,"   |      stop event: "+this.stopEvent.getEventName()+" "+this.stopEvent.eventDate),this.isStopEvent()&&null!==this.startEvent&&s.g.v(_,"   |      start event: "+this.startEvent.getEventName()+" "+this.startEvent.eventDate),null!==this.attachedEvent&&s.g.v(_,"   |      attached event: "+this.attachedEvent.getEventName()+" "+this.attachedEvent.eventDate)}toString(){return this.getEventName()+" ("+this.formatDate(this.eventDate)+")"}}class O{static BUFFER_SIZE=28;timeline;minIndex;initialBitrate;builder;summaryDuration;pauseDuration;nbNetworkDisconnected;nbNetworkWifi;nbNetworkMobile;nbNetworkEthernet;lastNetworkState;muteDuration;lastMuteState;constructor(t,e){this.timeline=t,this.minIndex=e,this.initialBitrate=void 0,this.builder=void 0,this.summaryDuration=0,this.pauseDuration=0,this.nbNetworkDisconnected=0,this.nbNetworkWifi=0,this.nbNetworkMobile=0,this.nbNetworkEthernet=0,this.lastNetworkState=void 0,this.muteDuration=0,this.lastMuteState=void 0,this.init()}init(){for(let t=this.minIndex;t>=0;t--){const e=this.timeline.events[t];switch(e.eventId){case w.LayerSwitch:case w.FirstImage:void 0===this.initialBitrate&&(this.initialBitrate=parseInt(e.eventData.bitrate,10));break;case w.Start:void 0===this.lastNetworkState&&(this.lastNetworkState=parseInt(e.eventData.networkType,10)),void 0===this.lastMuteState&&(this.lastMuteState=parseInt(e.eventData.muteState,10));break;case w.NetworkAvailable:void 0===this.lastNetworkState&&(this.lastNetworkState=parseInt(e.eventData.state,10));break;case w.NetworkLost:void 0===this.lastNetworkState&&(this.lastNetworkState=0);break;case w.Mute:void 0===this.lastMuteState&&(this.lastMuteState=1);break;case w.Unmute:void 0===this.lastMuteState&&(this.lastMuteState=0)}}void 0!==this.initialBitrate&&0!==this.initialBitrate||(this.initialBitrate=-1),void 0===this.lastNetworkState&&(this.lastNetworkState=1),void 0===this.lastMuteState&&(this.lastMuteState=0)}update(t){if(this.minIndex>=this.timeline.events.length||t>=this.timeline.events.length)return;const e=this.timeline.events[this.minIndex],a=this.timeline.events[t];let s,i,r,n=this.initialBitrate,o=e.eventDate,h=1===this.lastMuteState?e.eventDate:-1;this.builder=new k,this.summaryDuration=a.eventDate-e.eventDate,this.pauseDuration=0,this.nbNetworkDisconnected=0,this.nbNetworkWifi=0,this.nbNetworkMobile=0,this.nbNetworkEthernet=0,this.muteDuration=0;for(let l=this.minIndex;l<=t;l++){const t=this.timeline.events[l];switch(t.eventId){case w.Pause:!1!==s&&void 0!==s||(null!==t.stopEvent&&t.stopEvent.eventDate<=a.eventDate&&(this.pauseDuration+=t.stopEvent.eventDate-t.eventDate),s=!0);break;case w.Resume:void 0===s&&(this.pauseDuration+=t.eventDate-e.eventDate),s=!1;break;case w.StallStart:!1!==i&&void 0!==i||(null!==t.stopEvent&&t.stopEvent.eventDate<=a.eventDate&&this.builder.addStall(t.stopEvent.eventDate-t.eventDate),i=!0);break;case w.StallStop:void 0===i&&this.builder.addStall(t.eventDate-e.eventDate),i=!1;break;case w.RebufferingStart:!1!==r&&void 0!==r||(null!==t.stopEvent&&t.stopEvent.eventDate<=a.eventDate&&this.builder.addRebuffering(t.stopEvent.eventDate-t.eventDate),r=!0);break;case w.RebufferingStop:void 0===r&&this.builder.addRebuffering(t.eventDate-e.eventDate),r=!1;break;case w.LayerSwitch:this.builder.addLayerSwitch(),-1!==n&&this.builder.addTimeSpentPerLayer(n,t.eventDate-o),n=parseInt(t.eventData.bitrate,10),o=t.eventDate;break;case w.NetworkAvailable:this.lastNetworkState=parseInt(t.eventData.state,10),this.lastNetworkState>=10&&this.lastNetworkState<20?this.nbNetworkWifi++:this.lastNetworkState>=20&&this.lastNetworkState<30?this.nbNetworkMobile++:this.lastNetworkState>=30&&this.lastNetworkState<40&&this.nbNetworkEthernet++;break;case w.NetworkLost:this.lastNetworkState=0,this.nbNetworkDisconnected++;break;case w.Mute:this.lastMuteState=1,h=t.eventDate;break;case w.Unmute:this.lastMuteState=0,-1!==h&&(this.muteDuration+=t.eventDate-h,h=-1)}}-1!==n&&this.builder.addTimeSpentPerLayer(n,a.eventDate-o),-1!==h&&(this.muteDuration+=a.eventDate-h),this.builder.build()}data(){if(void 0===this.builder)return b.EMPTY;const t=new b(O.BUFFER_SIZE),e=this.builder.metrics;return t.put(w.DataSummary).putChar(Math.round(this.summaryDuration/1e3)).put(O.BUFFER_SIZE-2-1-1).putChar(this.pauseDuration/100).put(e.stallsNumber).putChar(e.totalStallsDuration/100).put(e.rebufferingsNumber).putChar(e.totalRebufferingDuration/100).put(e.layerSwitchesNumber).putChar(e.minBitrate).putChar(e.maxBitrate).putChar(e.averageBitrate).put(this.nbNetworkDisconnected).put(this.nbNetworkWifi).put(this.nbNetworkMobile).put(this.nbNetworkEthernet).putChar(this.lastNetworkState).putChar(Math.round(this.muteDuration/1e3)).put(this.lastMuteState),t}toString(){if(void 0===this.builder)return"no data";const t=this.builder.metrics;return this.summaryDuration+", "+this.pauseDuration+", "+t.minBitrate+", "+t.maxBitrate+", "+t.layerSwitchesNumber+", "+t.averageBitrate+", "+t.stallsNumber+", "+t.totalStallsDuration+", "+t.rebufferingsNumber+", "+t.totalRebufferingDuration+", "+this.nbNetworkDisconnected+", "+this.nbNetworkWifi+", "+this.nbNetworkMobile+", "+this.nbNetworkEthernet+", "+this.lastNetworkState+", "+this.muteDuration+", "+this.lastMuteState}}const F="BpkSessionTrackerEncoder";class V{static DEFAULT_BUFFER_SIZE=384;static DEFAULT_END_EVENTS_DURATION=15e3;static DEFAULT_END_EVENTS_NUMBER=20;timeline;maxBufferSize;maxEndEventsDuration;maxEndEventsNumber;events;uncompressedData;uncompressedDataFull;compressedStartData;minSummaryIndex;maxEndBufferSize;summary;constructor(t,e=V.DEFAULT_BUFFER_SIZE,a=V.DEFAULT_END_EVENTS_DURATION,s=V.DEFAULT_END_EVENTS_NUMBER){this.maxBufferSize=e,this.maxEndEventsDuration=a,this.maxEndEventsNumber=s,this.timeline=t,this.events=this.timeline.events,this.uncompressedData=new b(this.maxBufferSize),this.uncompressedDataFull=!1,this.compressedStartData=void 0,this.minSummaryIndex=0,this.maxEndBufferSize=this.maxBufferSize,this.summary=void 0}onEventAdded(t){if(this.uncompressedDataFull)return;let e=t;this.events.length>=2&&(e=this.events[this.events.length-2]),t.compressedData=t.toData(e.eventDate),t.compressed=!0,t.compressedData.capacity()<=this.uncompressedData.remaining()?this.uncompressedData.putByteBuffer(t.compressedData):(this.uncompressedDataFull=!0,this.compressedStartData=new b(this.maxBufferSize))}onEventUpdated(){this.uncompressedData=new b(this.maxBufferSize);for(let t=0;t<this.events.length;t++){void 0!==this.events[t].compressedData&&this.uncompressedData.putByteBuffer(this.events[t].compressedData)}}process(){const t=Date.now();if(!this.uncompressedDataFull)return s.g.d(F,"Timeline encoder generated uncompressed data ("+this.events.length+" events, "+this.uncompressedData.length()+" bytes)"),this.uncompressedData;let e,a="",i=[],r=0;for(let a=this.events.length-1;a>=0;a--){const s=this.events[a];if(!(t-s.eventDate<this.maxEndEventsDuration&&i.length<this.maxEndEventsNumber)){e=a;break}{let t;if(a<this.events.length-1){const e=this.events[a+1];t=s.toData(e.eventDate)}else t=s.toData(s.eventDate);if(!(r+t.length()<=this.maxEndBufferSize)){e=a;break}i.push(t),r+=t.length()}}if(0===this.compressedStartData.length()){this.minSummaryIndex=e;const t=this.maxBufferSize-O.BUFFER_SIZE-r;for(let a=0;a<e;a++){const e=this.events[a];if(this.compressedStartData.length()+e.compressedData.length()>t){this.minSummaryIndex=a;break}this.compressedStartData.putByteBuffer(e.compressedData)}this.maxEndBufferSize=this.compressedStartData.remaining()-O.BUFFER_SIZE,this.uncompressedData=void 0,a+="first iteration, "}let n=new b(this.maxBufferSize);if(n.putByteBuffer(this.compressedStartData,this.compressedStartData.length()),this.minSummaryIndex===e)n.put(w.EmptySummary),a+="no summary";else{void 0===this.summary&&(this.summary=new O(this.timeline,this.minSummaryIndex)),this.summary.update(e);const t=this.summary.data();n.putByteBuffer(t),a+="summary {"+this.summary.toString()+"}"}for(let t=0;t<i.length;t++)n.putByteBuffer(i[t]);return s.g.d(F,"Timeline encoder generated compressed data ("+this.events.length+" events before encoding, "+(this.minSummaryIndex+i.length)+" events after encoding, "+n.length()+" bytes, ~"+(Date.now()-t)+"ms, "+a+")"),n}extend(){if(this.uncompressedDataFull)s.g.w(F,"Failed to extend size from "+V.DEFAULT_BUFFER_SIZE+" to 768");else{this.maxBufferSize=768,this.maxEndEventsDuration=4e4,this.maxEndEventsNumber=40;let t=this.uncompressedData;this.uncompressedData=new b(this.maxBufferSize),this.uncompressedData.putByteBuffer(t,t.length()),s.g.v(F,"Extended size from "+V.DEFAULT_BUFFER_SIZE+" to 768")}}}const H="BpkSessionTrackerTimeline";class W{session;startDate;stopDate;events;firstImageWithoutBitrateEvent;encoder;constructor(){this.startDate=null,this.stopDate=null,this.events=[],this.firstImageWithoutBitrateEvent=null,this.encoder=new V(this)}pushEvent(t){if(this.checkType(t,N)){const e=this.createEvent(t);this.encoder.onEventAdded(e)}}pushEventStart(t,e,a){if(this.checkType(t,R)){const s=this.createEvent(t);s.addEventData("networkType",e),s.addEventData("muteState",a),this.encoder.onEventAdded(s)}}pushEventBitrate(t,e){if(this.checkType(t,B)){const a=this.createEvent(t);a.addEventData("bitrate",e),null!==this.firstImageWithoutBitrateEvent&&(this.firstImageWithoutBitrateEvent.addEventData("bitrate",e),this.firstImageWithoutBitrateEvent=null),this.encoder.onEventAdded(a)}}pushEventBitratePosition(t,e,a){if(this.checkType(t,M)){const s=this.createEvent(t);s.addEventData("bitrate",e),s.addEventData("position",a),t===w.FirstImage&&e<=0&&(this.firstImageWithoutBitrateEvent=s),this.encoder.onEventAdded(s)}}pushEventPositionStartEnd(t,e,a){if(this.checkType(t,T)){const s=this.createEvent(t);s.addEventData("positionStart",e),s.addEventData("positionEnd",a),this.encoder.onEventAdded(s)}}pushEventStatusCode(t,e){if(this.checkType(t,L)){const a=this.createEvent(t);a.addEventData("statusCode",e),this.encoder.onEventAdded(a)}}pushEventProgress(t,e){if(this.checkType(t,C)){const a=this.createEvent(t);a.addEventData("progress",e),this.encoder.onEventAdded(a)}}pushEventState(t,e){if(this.checkType(t,x)){const a=this.createEvent(t);a.addEventData("state",e),this.encoder.onEventAdded(a)}}createEvent(t){const e=new U(t);return s.g.v(H,"Creating event "+e.getEventName()+"..."),this.applyKeepLastOnly(e),this.events.push(e),this.updateTimelineProperties(e),this.reconciliateStopWithStartEvent(e),e}checkType(t,e){return e.indexOf(t)>=0||(s.g.v(H,"Can't push event '"+t+"' to timeline, invalid parameters"),!1)}applyKeepLastOnly(t){if(t.keepLastOnly)for(let e=this.events.length-1;e>=0;e--){if(this.events[e].eventId===t.eventId)return this.events.splice(e,1),void this.encoder.onEventUpdated()}}attachEvent(t){if(t.attachEventId>w.None){let e=-1;null!==t.startEvent&&-1!==t.attachMaxDurationBeforeStart&&(e=t.startEvent.eventDate-t.attachMaxDurationBeforeStart);for(let a=this.events.length-1;a>=0;a--){const s=this.events[a];if(s.eventId===t.attachEventId&&(-1===e||s.eventDate>=e))return void(t.attachedEvent=s)}}}updateTimelineProperties(t){switch(t.eventId){case w.Start:this.startDate=Date.now();break;case w.Stop:this.stopDate=Date.now()}}reconciliateStopWithStartEvent(t){if(t.isStopEvent())for(let e=this.events.length-1;e>=0;e--){const a=this.events[e];if(a.eventId===t.startEventId)return a.stopEvent=t,void(t.startEvent=a);if(a.eventId===t.triggerStartEventId)return a.eventId=t.startEventId,a.startStopEvent=!0,a.startEventId=t.startEventId,a.stopEventId=t.stopEventId,void 0!==a.compressedData&&(a.compressedData.set(a.eventId,0),this.encoder.onEventUpdated()),a.stopEvent=t,void(t.startEvent=a)}}onStart(t,e){this.pushEventStart(w.Start,t,e)}onRedirectionEnd(){this.pushEvent(w.RedirectionEnd)}onPrecacheEnded(){this.pushEvent(w.PrecacheEnded)}onFirstImage(t,e){this.pushEventBitratePosition(w.FirstImage,t,e)}onStop(t){this.pushEventStatusCode(w.Stop,t)}onForeground(){s.g.d(H,"Received event onForeground but ignored")}onBackground(){s.g.d(H,"Received event onBackground but ignored")}onNetworkAvailable(t){s.g.v(H,"Received event onNetworkAvailable type:"+t),this.pushEventState(w.NetworkAvailable,t)}onNetworkLost(){s.g.d(H,"Received event onNetworkLost"),this.pushEvent(w.NetworkLost)}onMute(){s.g.d(H,"Received event onMute"),this.pushEvent(w.Mute)}onUnmute(){s.g.d(H,"Received event onUnmute"),this.pushEvent(w.Unmute)}onMulticastUsed(){this.pushEvent(w.Multicast)}onUnicastUsed(){this.pushEvent(w.Unicast)}data(){return this.encoder.process()}formatDate(t){return D.A.formatDate(new Date(t))}print(){s.g.v(H,"Timeline (startDate:"+this.formatDate(this.startDate)+", stopDate:"+this.formatDate(this.stopDate)+")");for(let t=0;t<this.events.length;t++)this.events[t].print()}toString(){let t=[];for(let e=0;e<this.events.length;e++)t.push(this.events[e].toString());return t.join(", ")}}var K=a(828);const z="BpkAnalyticsSession";class j extends K.f{started;constructor(t,e){super(t,e),this.getURL=void 0,this.getQuery=void 0,this.startStreamingSession=void 0,this.stopAnalyticsSession=this.stopStreamingSession,this.stopStreamingSession=void 0,this.started=!1}attachPlayer(t,e){super.attachPlayer(t,e),void 0===this.handler&&(this.handler=this.smartLib.sessionManager.createSessionHandler(this),this.handler.initPlayerAdapter(),this.handler.addListener(this))}onLoading(){s.g.i(z,"Session is loading...",this.id),!1===this.started?(this.started=!0,this.handler.adSession=this.adSession,void 0!==this.adSession&&(this.adSession.handler=this.handler),this.handler.start("").catch((t=>{}))):s.g.d(z,"Exception: onLoading, the session is already running.",this.id)}updateSessionReportValue(t){const e=this.handler.sessionReport;void 0!==this.customParameters["report."+t]&&(e[t]=this.customParameters["report."+t])}onClose(t){s.g.i(z,"Session is closing (status code: "+t+")...",this.id),void 0!==this.handler.sessionReport.metrics&&(this.handler.sessionReport.metrics.redirectionTime=-1),this.updateSessionReportValue("requestedURL"),this.updateSessionReportValue("redirectedURL"),this.stopAnalyticsSession(t)}}var q=a(7418);const J="BpkCacheMgr";class Q{set(t,e){}get(t){}delete(t){}keys(){return[]}}class X{static CACHE_DURATION=1728e5;static CACHE_LIMIT=20;static#t;smartLib;cacheHandler;static getInstance(){return X.#t||(X.#t=new X),X.#t}constructor(){this.cacheHandler=new Q}init(t){this.cacheHandler=t}attachInstance(t){s.g.d(J,"Init cache manager..."),this.smartLib=t,this.getCacheData("report-").forEach((t=>{void 0!==t&&(t.value.sending=!1,this.store(t.key,t.value))}))}get(t){let e=this.cacheHandler.get(t);if(void 0!==e)try{return e.startsWith("{")||(e=E.A.base64ToString(e)),e=JSON.parse(e),e}catch(e){return LoggerManager.e(J,"Error while parsing "+t+" ("+e.message+")"),void this.cacheHandler.delete(t)}}store(t,e){this.cacheHandler.set(t,E.A.stringToBase64(JSON.stringify(e)))}update(t,e,a){const i=this.get(t);void 0!==i&&(s.g.d(J,"Updating "+t+", set "+e+" to "+a),i[e]=a,this.store(t,i))}storeSessionReport(t,e,a=!0,i=Date.now(),r=!1){const n="report-"+E.A.randomIntFromInterval(1e6,9999999)+i;s.g.i(J,"Storing "+n+" in cache...");let o={version:this.smartLib.getVersion(),date:i,sending:r,address:t,report:e};return this.store(n,o),!0===a&&this.clean(),n}deleteSessionReport(t){s.g.i(J,"Deleting "+t+" from cache..."),this.cacheHandler.delete(t)}storeKeepaliveReport(t,e){s.g.i(J,"Storing keepalive-"+e.session_id+" in cache...");let a={version:this.smartLib.getVersion(),date:Date.now(),address:t,report:e};this.store("keepalive-"+e.session_id,a)}deleteKeepaliveReport(t){s.g.i(J,"Deleting keepalive-"+t+" from cache..."),this.cacheHandler.delete("keepalive-"+t)}getCacheData(t=""){return this.cacheHandler.keys().filter((e=>e.startsWith(t))).map((t=>{const e=this.get(t);return void 0===e?void 0:{key:t,value:e}}))}push(){this.clean(),s.g.i(J,"Sending cache content if any..."),this.getCacheData("report-").forEach((t=>{void 0!==t&&(!0===t.value.sending?s.g.d(J,"Sending cache "+t.key+" already in progress..."):(s.g.d(J,"Sending cache "+t.key+"..."),t.value.sending=!0,t.value.report.delay=Math.round((Date.now()-t.value.date)/1e3),this.store(t.key,t.value),S.A.analyticsModule?.AnalyticsRequestManager.getInstance().endSessionCache(t.value.address,t.value.report,this.smartLib.getParameters()).then((e=>{!0===e?this.deleteSessionReport(t.key):(t.value.sending=!1,this.store(t.key,t.value))}))))}))}cleanExpiredData(t){return this.getCacheData(t).map((t=>void 0!==t&&(void 0===t.value.date||Date.now()-t.value.date>X.CACHE_DURATION)?(s.g.d(J,"Cleaning "+t.key+" (cache duration reached)..."),void this.cacheHandler.delete(t.key)):t)).filter((t=>void 0!==t)).sort(((t,e)=>e.value.date-t.value.date))}clean(){s.g.i(J,"Clean expired data if any...");const t=this.cleanExpiredData("keepalive-"),e=this.smartLib.sessionManager.sessions.map((t=>t.handler?.sessionReport?.sessionId));t.forEach((t=>{if(-1===e.indexOf(t.value.report.session_id)){s.g.d(J,"Migrating keepalive "+t.value.report.session_id+" to session..."),t.value.report.timeout=!0;t.value.address.split(",").forEach((e=>{0===e.indexOf(f.NOCACHE_PREFIX)?s.g.d(J,f.NOCACHE_PREFIX+" option used, no need to store the report in cache"):this.storeSessionReport(f.getInstance().buildAnalyticsAddress(e),t.value.report,!1,t.value.date)})),this.cacheHandler.delete(t.key)}}));const a=this.cleanExpiredData("report-");if(a.length>=X.CACHE_LIMIT)for(let t=X.CACHE_LIMIT;t<a.length;t++)this.deleteSessionReport(a[t].key)}release(){this.clean()}}class Y extends q.E{analyticsAddress;constructor(t){super(t),this.analyticsAddress=this.handler.smartLib.getParameters().analyticsAddress,s.g.d(J,"Using cache keepalive manager...",this.handler.id)}start(){super.start(),this.store()}callback(t,e=!0){this.store(),!0===e&&this.next()}stop(){super.stop(),this.delete()}store(){S.A.analyticsModule?.CacheManager.getInstance().storeKeepaliveReport(this.analyticsAddress,this.handler.sessionReport.toEndSessionJSON())}delete(){S.A.analyticsModule?.CacheManager.getInstance().deleteKeepaliveReport(this.handler.sessionReport.sessionId)}}class G extends q.q{cacheKeepaliveManager;constructor(t){super(t),this.cacheKeepaliveManager=new Y(t),this.cacheKeepaliveManager.next=()=>{}}start(){super.start(),this.cacheKeepaliveManager.store()}callback(t){this.cacheKeepaliveManager.callback(t),super.callback(t)}stop(){super.stop(),this.cacheKeepaliveManager.delete()}}S.A.analyticsModule={PlayerManager:p,PlayerAdapter:n,GenericPlayerAdapter:h,PlayerEventListener:d,GenericPlayerApi:m,AnalyticsRequestManager:f,SessionTrackerTimeline:W,SessionTrackerEvent:U,SessionTrackerEvents:w,Metrics:A,MetricsManager:P,AnalyticsSession:j,CacheManager:X,CacheKeepaliveManager:Y,BroadpeakCDNCacheKeepaliveManager:G}},7745:function(t,e,a){a.r(e),a.d(e,{AnalyticsRequestManager:function(){return i.bW},AnalyticsSession:function(){return i.Bw},BroadpeakCDNCacheKeepaliveManager:function(){return i._7},CacheHandler:function(){return o},CacheKeepaliveManager:function(){return i.sX},CacheManager:function(){return i.Go},GenericPlayerAdapter:function(){return i.qT},GenericPlayerApi:function(){return i.NQ},Metrics:function(){return i.K1},MetricsManager:function(){return i.pi},PlayerAdapter:function(){return i.nm},PlayerEventListener:function(){return i.Wy},PlayerManager:function(){return i.dx},SessionTrackerEvent:function(){return i.lX},SessionTrackerEvents:function(){return i.c5},SessionTrackerTimeline:function(){return i.EC}});var s=a(8100),i=a(5207);var r=a(1262);const n="sl-";class o{storage;constructor(){if(r.gD.d("BpkCacheHandler","Init cache handler, localStorage is "+("undefined"!=typeof localStorage?"available":"unavailable")+"..."),this.storage={},"undefined"!=typeof localStorage){let t=[];for(let e=0;e<localStorage.length;e++)t.push(localStorage.key(e));t.filter((t=>t.startsWith(n))).map((t=>({key:t,value:localStorage.getItem(t)}))).forEach((t=>{void 0!==t.value&&(this.storage[t.key]=t.value)}))}}set(t,e){t=n+t,this.storage[t]=e,setTimeout((()=>{localStorage?.setItem(t,e)}),1)}get(t,e=!1){if(!1===e&&(t=n+t),t in this.storage)return this.storage[t];let a;return"undefined"!=typeof localStorage&&(a=localStorage.getItem(t)),null!=a?(this.storage[t]=a,a):void 0}delete(t){t=n+t,delete this.storage[t],setTimeout((()=>{localStorage?.removeItem(t)}),1)}keys(){return void 0!==this.storage?Object.keys(this.storage).map((t=>t.replace(n,""))):[]}}s.A.analyticsModule={PlayerManagerHandler:class{#i;loadPlayerAdapters(){return this.#i={},this.#i.generic=i.qT,this.addAdapter("voplayer",s.A.voplayerModule?.VOPlayerAdapter),this.addAdapter("theoplayer",s.A.theoplayerModule?.THEOPlayerAdapter),this.addAdapter("shaka",s.A.shakaModule?.ShakaPlayerAdapter),this.addAdapter("dashjs",s.A.dashjsModule?.DashJsPlayerAdapter),this.addAdapter("html5",s.A.html5Module?.HTML5PlayerAdapter),this.addAdapter("avplay",s.A.avplayModule?.AVPlayAdapter),this.addAdapter("diw387",s.A.diw387Module?.SagemcomDIW387Adapter),this.addAdapter("hbbtv1",s.A.hbbtv1Module?.HbbTV1PlayerAdapter),this.addAdapter("kaltura",s.A.kalturaModule?.KalturaPlayerAdapter),this.addAdapter("connectplayer",s.A.connectplayerModule?.ConnectPlayerAdapter),this.addAdapter("rxplayer",s.A.rxplayerModule?.RxPlayerAdapter),this.addAdapter("videojs",s.A.videojsModule?.VideoJsPlayerAdapter),this.addAdapter("hlsjs",s.A.hlsjsModule?.HlsJsPlayerAdapter),this.addAdapter("bitmovin",s.A.bitmovinModule?.BitmovinPlayerAdapter),this.addAdapter("reactnativeconnectplayer",s.A.reactnativeconnectplayerModule?.ReactNativeConnectPlayerAdapter),this.addAdapter("reactnativetheoplayer",s.A.reactnativetheoplayerModule?.ReactNativeTHEOplayerAdapter),this.addAdapter("chromecast",s.A.chromecastModule?.ChromecastPlayerAdapter),this.#i}addAdapter(t,e){void 0!==e&&(this.#i[t]=e)}attachPlayer(t,e){for(let a in this.#i)if(void 0!==this.#i[a]&&this.#i[a].checkPlayer(t,e)){const s=new this.#i[a];return s.attachPlayer(t,e),s}}},PlayerEventListener:i.Wy,GenericPlayerApi:i.NQ,CacheHandler:o},s.A.getInstance().registerPlayerAdapters()}},function(t){var e;return e=7745,t(t.s=e)}])}));