"use strict";!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define("adSmartLibModule",[],i):"object"==typeof exports?exports.adSmartLibModule=i():t.adSmartLibModule=i()}("undefined"!=typeof self?self:global,(function(){return(("undefined"!=typeof self?self:global).webpackChunkSmartLibModule=("undefined"!=typeof self?self:global).webpackChunkSmartLibModule||[]).push([[256],{7575:function(t,i,s){s.r(i),s.d(i,{AdBreakTracker:function(){return u},AdDataTracker:function(){return l},AdEventTracker:function(){return k},AdFriendlyObstructionPurpose:function(){return f.D6},AdManager:function(){return f.X2},AdMetrics:function(){return a},AdMetricsBuilder:function(){return r},AdMetricsManager:function(){return m},AdSession:function(){return D.A},AdTracker:function(){return g},AdTrackingManager:function(){return P},AdType:function(){return f.eQ},AdViewState:function(){return f.up},InternalAdManager:function(){return v.A},OMSDKManager:function(){return y},OMSessionHandler:function(){return I}});var e=s(3445);class a{adSkippable;adSkipped;adProgress;adDuration;stallsNumber;stallsDuration;layerSwitchesNumber;averageBitrate;creativeId;adId;adIndex;adCount;adFormat;impressionDate;constructor(t=void 0){void 0===t?(this.adSkippable=!1,this.adSkipped=!1,this.adProgress=-1,this.adDuration=0,this.stallsNumber=0,this.stallsDuration=0,this.layerSwitchesNumber=0,this.averageBitrate=0,this.creativeId="",this.adId="",this.adIndex=-1,this.adCount=-1,this.adFormat="",this.impressionDate=-1):(this.adSkippable=t.adSkippable,this.adSkipped=t.adSkipped,this.adProgress=t.adProgress,this.adDuration=t.adDuration,this.stallsNumber=t.stallsNumber,this.stallsDuration=t.stallsDuration,this.layerSwitchesNumber=t.layerSwitchesNumber,this.averageBitrate=t.averageBitrate,this.creativeId=t.creativeId,this.adId=t.adId,this.adIndex=t.adIndex,this.adCount=t.adCount,this.adFormat=t.adFormat,this.impressionDate=t.impressionDate)}static merge(t){if(void 0!==t&&t.length>0){const i=new a,s=t[t.length-1];i.adSkippable=s.adSkippable,i.adSkipped=s.adSkipped,i.adProgress=s.adProgress,i.creativeId=s.creativeId,i.adId=s.adId;let e=0,r=0;for(let s=0;s<t.length;s++){const a=t[s];i.adDuration+=a.adDuration,i.stallsNumber+=a.stallsNumber,i.stallsDuration+=a.stallsDuration,i.layerSwitchesNumber+=a.layerSwitchesNumber,e+=a.averageBitrate*a.adDuration,r+=a.adDuration}return 0!==r&&(i.averageBitrate=Math.round(e/r)),i}}toString(){return"\n{ adSkippable="+this.adSkippable+"\n  adSkipped="+this.adSkipped+"\n  adProgress="+this.adProgress+"\n  adDuration="+this.adDuration+"\n  stallsNumber="+this.stallsNumber+"\n  stallsDuration="+this.stallsDuration+"\n  layerSwitchesNumber="+this.layerSwitchesNumber+"\n  averageBitrate="+this.averageBitrate+"\n  creativeId='"+this.creativeId+"'\n  adId='"+this.adId+"'\n  adIndex="+this.adIndex+"\n  adCount="+this.adCount+"\n  adFormat='"+this.adFormat+"'\n  impressionDate="+this.impressionDate+" ("+e.A.formatTime(this.impressionDate)+")\n}"}}class r{adMetrics;timeSpentPerLayer;quartiles;constructor(t=void 0,i=void 0,s=void 0){void 0===t&&void 0===i&&void 0===s?(this.timeSpentPerLayer={},this.quartiles={},this.reset()):(this.adMetrics=t,this.timeSpentPerLayer=i,this.quartiles=s)}isInitialized(){return""!==this.adMetrics.adId}import(t){return void 0!==t&&1===t.length&&t[0].impressionDate<=0&&(this.adMetrics=t[0]),this.adMetrics.impressionDate=Date.now(),this}setAdSkippable(t){return this.adMetrics.adSkippable=t,this}setAdSkipped(t){return this.adMetrics.adSkipped=t,this}addProgress(t){return this.quartiles[t]=!0,this.adMetrics.adProgress=Math.max(this.adMetrics.adProgress,t),this}init(t,i,s){return this.adMetrics.adFormat=t,this.adMetrics.adIndex=i,this.adMetrics.adCount=s,this}setCreativeId(t){return this.adMetrics.creativeId=t,this}setAdId(t){return this.adMetrics.adId=t,this}addTimeSpentPerLayer(t,i){if((t=Math.round(t))>0){void 0!==this.timeSpentPerLayer[t]?this.timeSpentPerLayer[t]+=i:this.timeSpentPerLayer[t]=i}return this}addLayerSwitch(){return this.adMetrics.layerSwitchesNumber++,this}addStall(t){return this.adMetrics.stallsNumber++,this.adMetrics.stallsDuration+=t,this}reset(){return this.adMetrics=new a,this.timeSpentPerLayer={},this.quartiles={},this}clone(){return new r(new a(this.adMetrics),Object.assign({},this.timeSpentPerLayer),Object.assign({},this.quartiles))}build(){let t=0,i=0;for(const s in this.timeSpentPerLayer){const e=this.timeSpentPerLayer[s];t+=s*e,i+=e}return 0!==i&&(this.adMetrics.averageBitrate=Math.round(t/i)),this.adMetrics.adDuration=i,this.adMetrics}}var n=s(8379),d=s(1142),o=s(1134),h=s(6506);const c="BpkAdTracker";class p{proceeded;constructor(){this.proceeded={},this.prepared=!1}canProcess(t=0){const i=void 0===this.proceeded[t];return i&&(this.proceeded[t]=Date.now()),i}resetProcess(){this.proceeded={}}}class l{adTrackingManager;sessionToken;timeReference;adBreaks;constructor(t,i,s){this.adTrackingManager=t,this.sessionToken=i,this.timeReference=s,this.adBreaks=[]}hasRemainingAdBreaks(t){return void 0!==this.adBreaks.find((i=>t<i.position+i.duration))}resetProgression(t){this.adBreaks.forEach((i=>i.resetProgression(t)))}}class u extends p{adData;id;position;duration;live;ads;constructor(t,i,s,e,a){super(),this.adData=t,this.id=i,this.position=s,this.duration=e,this.live=a,this.ads=[]}resetProgression(t){t<=this.position&&this.resetProcess(),this.ads.forEach((i=>i.resetProgression(t)))}processPrepare(){const t=this.adData.adTrackingManager,i=t.handler.adSession?.adEventsListener;!1===this.prepared&&void 0!==i?.onPrepareAdBreak&&(i.onPrepareAdBreak(this.toData()),this.prepared=!0)}processBegin(){if(!this.canProcess(0))return;const t=this.adData.adTrackingManager;n.g.d(c,"Processing ad break begin...",t.handler.id),n.g.d(c,"Duration: "+this.duration+"ms",t.handler.id),t.notifyAdBreakData(this),t.notifyAdBreakBegin(this.adData.sessionToken);const i=t.handler.adSession?.adEventsListener;this.processPrepare(),i?.onAdBreakBegin(this.toData())}processEnd(){if(!this.canProcess(1))return;const t=this.adData.adTrackingManager;n.g.d(c,"Processing ad break end...",t.handler.id),t.notifyAdBreakEnd(this.adData.sessionToken);const i=t.handler.adSession?.adEventsListener;i?.onAdBreakEnd(this.toData()),this.resetProcess(),this.prepared=!1}resetProcess(){super.resetProcess(),this.ads.forEach((t=>t.resetProcess()))}toData(){return{id:this.id,startPosition:this.position||0,duration:!0===this.live?-1:this.duration,ads:this.ads.map((t=>t.toData())),adCount:!0===this.live?-1:this.ads.length}}}class g extends p{adType;adBreak;index;position;duration;skippablePosition;skippable;creativeId;adId;events;clickable;verifications;watched;progression;nonLinearInfo;errorURL;constructor(t,i,s,e,a,r,n,d,o,h,c,p,l){super(),this.adType=t,this.adBreak=i,this.index=s,this.position=e,this.duration=a,this.skippable=r,this.skippablePosition=n,this.creativeId=d,this.adId=o,this.events=[],this.clickable=h,this.verifications=c,this.watched=[],this.progression=0,this.nonLinearInfo=p,this.errorURL=l}flatWatched(){let t=JSON.parse(JSON.stringify(this.watched)).slice(0);const i=[];let s=null;t=t.sort(((t,i)=>t[0]>i[0]?1:t[0]<i[0]?-1:0)),i.push(t[0]);for(let e=1;e<t.length;e++)s=i[i.length-1],s[1]<t[e][0]?i.push(t[e]):s[1]<t[e][1]&&(s[1]=t[e][1],i.pop(),i.push(s));this.watched=i}resetProgression(t){t<=this.position&&(this.watched=[],this.progression=0,this.resetProcess()),this.events.forEach((i=>i.resetProgression(t)))}updateProgression(t,i){if(t>i||t<this.position||i<this.position||t>this.position+this.duration||i>this.position+this.duration)return;const s=this.watched.reduce(((t,i)=>t+(i[1]-i[0])),0)/this.duration;this.watched.push([t-this.position,i-this.position]),this.flatWatched();const e=this.watched.reduce(((t,i)=>t+(i[1]-i[0])),0)/this.duration;this.progression=e;const a=this.adBreak.adData,r=a.adTrackingManager;s<=.25&&e>=.25&&r.notifyAdProgress(a.sessionToken,this,25),s<=.5&&e>=.5&&r.notifyAdProgress(a.sessionToken,this,50),s<=.75&&e>=.75&&r.notifyAdProgress(a.sessionToken,this,75),this.events.forEach((t=>t.processEvents(s,e))),1===s&&1===e?n.g.d(c,"Ad already seen (100%)",r.handler.id):n.g.d(c,"Ad progressed from "+Math.floor(1e5*s)/1e3+"% to "+Math.floor(1e5*e)/1e3+"%",r.handler.id)}processPrepare(){const t=this.adBreak.adData.adTrackingManager,i=t.handler.adSession?.adEventsListener;!1===this.prepared&&void 0!==i?.onPrepareAd&&(i.onPrepareAd(this.toData(),this.adBreak.toData()),this.prepared=!0)}processBegin(){if(!this.canProcess(0))return;const t=this.adBreak.adData,i=t.adTrackingManager;n.g.d(c,"Processing ad begin "+this.adId+"...",i.handler.id),n.g.d(c,"Start: "+this.position+"ms",i.handler.id),n.g.d(c,"End  : "+(this.position+this.duration)+"ms",i.handler.id),n.g.d(c,"Duration: "+this.duration+"ms",i.handler.id),n.g.d(c,"Type: "+this.adType,i.handler.id),i.notifyAdData(this),i.notifyAdBegin(t.sessionToken,this),!0===this.skippable&&i.notifyAdSkippable(t.sessionToken,this.skippablePosition,this.position+this.duration,this.adBreak.position+this.adBreak.duration),i.notifyAdProgress(t.sessionToken,this,0);const s=i.handler.adSession?.adEventsListener,e=this.toData(),a=this.adBreak.toData();this.processPrepare(),s?.onAdBegin(e,a),!0===this.skippable&&s?.onAdSkippable(e,a,this.skippablePosition,this.position+this.duration,this.adBreak.position+this.adBreak.duration)}processEnd(){if(!this.canProcess(1))return;const t=this.adBreak.adData,i=t.adTrackingManager;n.g.d(c,"Processing ad end "+this.adId+"...",i.handler.id),this.progression>=.95&&(this.updateProgression(this.position,this.position+this.duration),i.notifyAdProgress(t.sessionToken,this,100)),i.notifyAdEnd(t.sessionToken,this);const s=i.handler.adSession?.adEventsListener;s?.onAdEnd(this.toData(),this.adBreak.toData()),this.resetProcess(),this.prepared=!1}getNonLinearResources(t){return this.nonLinearInfo.filter((i=>""!==i[t])).map((i=>({url:i[t],parameters:i.adParameters})))}toData(){return{adType:this.adType,index:this.index,creativeId:this.creativeId,adId:this.adId,startPosition:this.position,skipPosition:this.skippablePosition,duration:this.duration,clickURL:this.clickable.uri,nonLinearIframeResources:this.getNonLinearResources("iframeResource"),nonLinearStaticResources:this.getNonLinearResources("staticResource")}}}class k extends p{ad;type;url;offset;position;progression;constructor(t,i,s,e,a){super(),this.ad=t,this.type=i,this.url=s,this.offset=e,this.position=a,this.progression=0,this.processProgression()}resetProgression(t){t<=this.ad.position&&this.resetProcess()}processProgression(){switch(void 0!==this.type?this.type.toLowerCase():void 0){case void 0:this.progression=(this.position-this.ad.position)/this.ad.duration;break;case"start":this.progression=0;break;case"firstquartile":this.progression=.25;break;case"midpoint":this.progression=.5;break;case"thirdquartile":this.progression=.75;break;case"complete":this.progression=1;break;case"progress":this.progression=this.offset/this.ad.duration;break;case"impression":this.progression=0}}processEvents(t,i){const s=this.ad.adBreak.adData.adTrackingManager;if(t<=this.progression&&this.progression<=i){if(!this.canProcess())return!1;n.g.d(c,"Processing "+(this.type||"timed event")+" ("+Math.floor(100*this.progression)+"%)...",s.handler.id),void 0!==this.url&&this.url.length>0&&(n.g.d(c,"Requesting "+this.url,s.handler.id),h.A.getInstance().adEvent(s.handler,this.url))}return!0}}var f=s(5690);const A="BpkAdTrackingMgr";class P{static POSITION_UPDATE_INTERVAL=1e3;static POSITION_START_DELTA=4e3;static POSITION_SEEK_ERROR_DELTA=6e3;static POSITION_PREPARE_DELTA=3e3;static SESSION_UPDATE_INTERVAL=5e3;handler;playerAdapter;listeners;adData;adList;updatePositionJob;updateSessionJob;started;paused;buffering;lastPosition;lastPositionBeforePause;lastPositionAfterSeek;firstImageDate;currentAdTracker;currentAdBreakTracker;currentAdData;currentAdBreakData;adPalSession;bkYouSession;sessionToken;baseURL;nonce;adPalSessionRequest;firstFileReceived;firstFileProceeded;podsSentNumber;sessionUpdateInterval;positionHistory;constructor(t,i){this.handler=t,this.playerAdapter=i,this.listeners=[],this.adData=void 0,this.adList=[],this.updatePositionJob=void 0,this.updateSessionJob=void 0,this.started=!1,this.paused=!1,this.buffering=!1,this.lastPosition=0,this.lastPositionBeforePause=0,this.lastPositionAfterSeek=0,this.bkYouSession=!1,this.baseURL=void 0,this.nonce=void 0,this.adPalSessionRequest=void 0,this.firstFileReceived=!1,this.firstFileProceeded=!1,this.podsSentNumber=0,this.sessionUpdateInterval=P.SESSION_UPDATE_INTERVAL,this.positionHistory=[]}initBkYouSession(t,i,s,e,a){this.baseURL=t,this.sessionToken=i,this.bkYouSession=!0,void 0!==e&&(this.adPalSession=e,this.nonce=a),this.parseAdPods(s),n.g.d(A,"BkYou session initialized",this.handler.id)}updateBkYouSession(){if(!0!==this.handler.stopped&&!0===this.bkYouSession){n.g.d(A,"Updating ad tracking file...",this.handler.id);let t=this.baseURL;const i={userAgent:this.handler.smartLib.getParameters().userAgent};h.A.getInstance().adTracking(this.handler,i,t,!0).then((t=>{if(!0!==this.handler.stopped)if(void 0!==this.updateSessionJob&&o.A.getInstance().cancel(this.updateSessionJob),t.httpStatus>=200&&t.httpStatus<300){let i;try{i=JSON.parse(t.content)}catch(t){return n.g.d(A,"Ad tracking updated file unreadable",this.handler.id),void(!0===this.firstFileReceived&&(this.updateSessionJob=o.A.getInstance().asyncDelay(this.sessionUpdateInterval,(()=>{this.updateSessionJob=void 0,this.updateBkYouSession()}))))}this.firstFileReceived=!0,this.parseAdPods(i),this.isLive()?this.updateSessionJob=o.A.getInstance().asyncDelay(this.sessionUpdateInterval,(()=>{this.updateSessionJob=void 0,this.updateBkYouSession()})):n.g.d(A,"Stopping ad tracking file update (VOD stream)...",this.handler.id)}else n.g.d(A,"Stopping ad tracking file update (status code "+t.httpStatus+")",this.handler.id)}))}}fixAdBreak(t){let i;t.ads.forEach(((s,e)=>{const a=t.ads[e+1];void 0!==a&&a.position<s.position+s.duration&&(a.position=s.position+s.duration,a.events.filter((t=>t.position<a.position)).forEach((t=>{t.position=a.position}))),i=s})),void 0!==i&&(t.duration=i.position+i.duration-t.position)}parseAdPods(t){const i=t.sessiontoken||"",s=t.timereference_ms||0,e=t.refresh_delay_ms||P.SESSION_UPDATE_INTERVAL;e>=2e3&&e<=P.SESSION_UPDATE_INTERVAL?(this.sessionUpdateInterval=e,n.g.d(A,"Setting refresh delay to "+this.sessionUpdateInterval+"ms",this.handler.id)):n.g.d(A,"Setting refresh delay to "+P.SESSION_UPDATE_INTERVAL+"ms (default value)",this.handler.id);const a=new l(this,i,s),r=t.adpods;Array.isArray(r)&&(r.forEach((t=>{const i=t.id||"",e=t.starttime_ms+s;let r=t.duration_ms||0;const n=t.ads,d=new u(a,i,e,r,this.isLive());Array.isArray(n)&&n.forEach(((t,i)=>{const e=t.starttime_ms+s,a=t.duration_ms,r=t.trackingevents;let n=!0;if(Array.isArray(r)&&r.length>0&&(n=e>0&&r[0].time_ms>0||0===e),void 0!==e&&void 0!==a&&!0===n){const n=f.eQ.getAdType(t.adtype),o=t.skippable_ms+s||0,h=0!==o&&null!=o,c=t.creativeid||"",p=t.adid+"-"+e||"",l={uri:t.videoclicks?.clickthroughurl||"",trackers:t.videoclicks?.clicktracking||[],customClick:t.videoclicks?.customclick||[]},u=t.adverifications||[];let A=[];u.forEach((t=>{A.push({vendor:t.vendor||"",javascriptResources:t.javascriptresources||[],executableResources:t.executableresources||[],trackingEvents:t.trackingevents||[],verificationParameters:t.verificationparameters||""})}));const P=t.nonlinearinfo||[];let S=[];P.forEach((t=>{S.push({staticResource:t.staticresource||"",iframeResource:t.iframeresource||"",adParameters:t.adparameters||"",trackingEvents:t.trackingevents||[]})}));const m=t.errorurl||"",D=new g(n,d,i,e,a,h,o,c,p,l,A,S,m);d.ads.push(D),Array.isArray(r)&&r.forEach((t=>{const i=t.callbackurl;if(void 0!==i){const a=t.type,r=t.offset_ms,n=t.time_ms+s||e,d=new k(D,a,i,r,n);D.events.push(d)}}))}})),d.ads.length>0&&a.adBreaks.push(d)})),a.adBreaks.forEach((t=>{this.fixAdBreak(t)})));let d=this.mergeEvents(a);this.adList=this.adData.adBreaks.map((t=>t.toData())),this.notifyAdDataListener(d)}start(){void 0===this.updatePositionJob&&(this.updatePositionJob=o.A.getInstance().asyncDelay(P.POSITION_UPDATE_INTERVAL,(()=>{this.updatePositionJob=void 0,this.onPositionUpdated(this.playerAdapter.getPosition())})))}stop(){void 0!==this.updatePositionJob&&(n.g.d(A,"Ad tracking paused (player event)",this.handler.id),o.A.getInstance().cancel(this.updatePositionJob),this.updatePositionJob=void 0)}isLive(){return void 0!==this.firstImageDate&&this.playerAdapter.getDuration()<=0}mergeEvents(t){let i=!1;if(void 0===this.adData)this.adData=t,n.g.d(A,t.adBreaks.length+" ad break(s) parsed",this.handler.id),i=!0;else{let s=0,e=0;this.adData.sessionToken=t.sessionToken,this.adData.timeReference=t.timeReference;const a=t.adBreaks.map((t=>t.id));this.adData.adBreaks.forEach(((t,s,r)=>{a.includes(t.id)||this.currentAdTracker?.adBreak.id===t.id||(r.splice(s,1),e++,i=!0)})),t.adBreaks.forEach(((t,e)=>{t.adData=this.adData;const a=this.adData.adBreaks.find((i=>i.id===t.id));if(void 0!==a){t.ads.filter((t=>void 0===a.ads.find((i=>i.adId===t.adId)))).forEach((t=>{const e=a.ads.findIndex((i=>i.position>t.position));-1===e?a.ads.push(t):a.ads.splice(e,0,t),s++,i=!0}));const r=a.duration;this.fixAdBreak(a),r!==a.duration&&n.g.d(A,"Ad break "+(e+1)+"/"+this.adData.adBreaks.length+": updated duration from "+r+" to "+a.duration,this.handler.id)}else this.adData.adBreaks.push(t),s+=t.ads.length,i=!0})),n.g.d(A,this.adData.adBreaks.length+" ad break(s) in total, "+t.adBreaks.length+" ad break(s) parsed, "+s+" new ad(s), "+e+" deleted ad(s)",this.handler.id)}if(this.notifyAdsUpdated(this.adData),this.started&&!this.paused&&!this.buffering){const t=this.playerAdapter.getPosition();void 0===this.updatePositionJob&&this.adData.hasRemainingAdBreaks(t)>0&&(n.g.d(A,"Ad tracking resumed",this.handler.id),this.lastPosition=t),this.checkStart(),this.isLive()&&this.checkAdBreakEnded(t)}return i}onPositionUpdated(t){let i=this.lastPosition!==t?this.lastPosition:t-1,s=t;if(!0===this.firstFileReceived&&!1===this.firstFileProceeded&&(this.firstFileProceeded=!0,n.g.d(A,"Processing all events since first image...",this.handler.id),void 0===this.positionHistory[this.positionHistory.length-1].end&&(this.positionHistory[this.positionHistory.length-1].end=t),this.positionHistory.forEach((t=>{n.g.d(A,"Between "+t.start+" and "+t.end,this.handler.id),this.lastPosition=t.start;for(let i=t.start;i<=t.end+P.POSITION_UPDATE_INTERVAL;i+=P.POSITION_UPDATE_INTERVAL){const s=Math.min(i,t.end);this.onPositionUpdated(s),this.lastPosition=s}})),n.g.d(A,"Tracking catch-up finished",this.handler.id)),i<s&&s-i<P.POSITION_SEEK_ERROR_DELTA){const e=this.adData?.adBreaks.find((t=>t.position<=s&&s<t.position+t.duration)),a=this.adData?.adBreaks.find((t=>t.position<=s+P.POSITION_PREPARE_DELTA&&s+P.POSITION_PREPARE_DELTA<t.position+t.duration)),r=e?.ads.find((t=>t.position<=s&&s<t.position+t.duration)),d=a?.ads.find((t=>t.position<=s+P.POSITION_PREPARE_DELTA&&s+P.POSITION_PREPARE_DELTA<t.position+t.duration));if(a?.processPrepare(),d?.processPrepare(),void 0!==r){if(void 0===this.currentAdTracker){n.g.d(A,"Entering ad "+r.adId+"...",this.handler.id);const t=i-r.position>=P.POSITION_SEEK_ERROR_DELTA;t||(n.g.d(A,"Update position start from "+i+" to "+r.position,this.handler.id),i=r.position),this.currentAdData=r.toData(),this.currentAdBreakData=e.toData(),e.processBegin(),r.processBegin(),r.updateProgression(i,s),t&&(n.g.d(A,"Ad skipped (previous position was "+P.POSITION_SEEK_ERROR_DELTA+"ms after ad start)",this.handler.id),this.notifyAdSkipped(this.adData.sessionToken,r))}else this.currentAdTracker===r?r.updateProgression(i,s):this.currentAdTracker!==r&&(n.g.d(A,"Changing from ad "+this.currentAdTracker.adId+" to "+r.adId+"...",this.handler.id),r.adBreak.id===this.currentAdTracker.adBreak.id&&this.currentAdTracker.updateProgression(i,this.currentAdTracker.position+this.currentAdTracker.duration),this.currentAdTracker.progression<1&&(n.g.d(A,"Ad skipped (progression not complete)",this.handler.id),this.notifyAdSkipped(this.adData.sessionToken,this.currentAdTracker)),this.currentAdTracker.processEnd(),r.adBreak.id!==this.currentAdTracker.adBreak.id?(this.currentAdTracker.adBreak.processEnd(),this.currentAdData=r.toData(),this.currentAdBreakData=e.toData(),e.processBegin()):this.currentAdData=r.toData(),r.processBegin(),s-r.position>=P.POSITION_SEEK_ERROR_DELTA?(n.g.d(A,"Ad skipped (new position is "+P.POSITION_SEEK_ERROR_DELTA+"ms after ad start)",this.handler.id),this.notifyAdSkipped(this.adData.sessionToken,r)):r.updateProgression(r.position,s));this.currentAdTracker=r,this.currentAdBreakTracker=e}else void 0!==this.currentAdTracker&&(n.g.d(A,"Exiting ad "+this.currentAdTracker.adId+"...",this.handler.id),s-(this.currentAdTracker.position+this.currentAdTracker.duration)<P.POSITION_UPDATE_INTERVAL&&(s=this.currentAdTracker.position+this.currentAdTracker.duration),i>=this.currentAdTracker.position&&this.currentAdTracker.updateProgression(i,s),this.currentAdTracker.progression<1&&(n.g.d(A,"Ad skipped (progression not complete)",this.handler.id),this.notifyAdSkipped(this.adData.sessionToken,this.currentAdTracker)),this.currentAdTracker.processEnd(),void 0!==e||this.isLive()||(this.currentAdBreakTracker.processEnd(),this.currentAdBreakTracker=void 0,this.currentAdBreakData=void 0),this.currentAdTracker=void 0,this.currentAdData=void 0);this.lastPosition=t,this.adData?.hasRemainingAdBreaks(s)?this.paused||this.buffering?n.g.d(A,"Ad tracking paused (playback paused, onPositionUpdated)",this.handler.id):this.start():n.g.d(A,"Ad tracking paused (no more event, onPositionUpdated)",this.handler.id)}else n.g.d(A,"Processing trackers from "+i+"ms to "+s+"ms, resuming tracking...",this.handler.id),this.adData?.hasRemainingAdBreaks(s)&&(this.paused||this.buffering||this.start())}checkStart(t=this.playerAdapter.getPosition()){this.adData?.hasRemainingAdBreaks(t)>0?this.onPositionUpdated(t):n.g.d(A,"Ad tracking paused (no more event, checkStart)",this.handler.id)}checkAdBreakEnded(t){let i=this.lastPosition!==t?this.lastPosition:t-1,s=t;if(i<s&&s-i<P.POSITION_SEEK_ERROR_DELTA){const t=this.adData?.adBreaks.find((t=>t.position<=s&&s<t.position+t.duration));void 0!==this.currentAdBreakTracker&&(void 0===t?(void 0!==this.currentAdTracker&&this.currentAdTracker.position+this.currentAdTracker.duration-s<P.POSITION_SEEK_ERROR_DELTA&&(this.currentAdTracker.updateProgression(this.currentAdTracker.position,this.currentAdTracker.position+this.currentAdTracker.duration),this.currentAdTracker.processEnd(),this.currentAdTracker=void 0,this.currentAdData=void 0),this.currentAdBreakTracker.processEnd(),this.currentAdBreakTracker=void 0,this.currentAdBreakData=void 0,n.g.d(A,"Ad break end detected",this.handler.id)):n.g.d(A,"Ad break not yet ended",this.handler.id))}}adUserInteraction(t){this.currentAdTracker?.clickable?.trackers.forEach((t=>{n.g.d(A,"Requesting click tracker "+t.clickurl,this.handler.id),h.A.getInstance().adEvent(this.handler,t.clickurl)}))}getCurrentAd(){return this.currentAdData}getCurrentAdBreak(){return this.currentAdBreakData}getPositionForBookmark(){if(this.playerAdapter.getDuration()>0){let t=this.playerAdapter.getPosition();const i=this.adList.find((i=>i.startPosition<t&&t<=i.startPosition+i.duration));return void 0!==i&&(t=i.startPosition),this.adList.filter((i=>i.startPosition+i.duration<t)).forEach((i=>{t-=i.duration})),t}return-1}getPositionForPlayback(t,i){let s=t;const e=this.adList.sort(((t,i)=>t.startPosition-i.startPosition));let a;for(let t=0;t<e.length;t++){const i=e[t];if(i.startPosition>s)break;s+=i.duration,a=i}return!0===i&&void 0!==a&&s===a.startPosition+a.duration?a.startPosition:s}onFirstImage(t,i){this.started=!0,this.paused=!1,this.buffering=!1,this.lastPosition=i,this.firstImageDate=Date.now(),this.positionHistory.push({start:i}),n.g.d(A,"Ad tracking enabled (live:"+this.isLive()+")",this.handler.id),void 0!==this.adData&&(this.adList=this.adData.adBreaks.map((t=>(t.live=this.isLive(),t.toData())))),this.checkStart(i),this.updateBkYouSession(),this.isLive()&&this.playerAdapter.getPosition()<12623004e5&&n.g.e(A,"The player position does not return a position as a timestamp in millis. The ad tracking might not work.",this.handler.id),this.adPalSession?.sendPlaybackStart()}onPause(){const t=this.playerAdapter.getPosition();this.buffering||this.firstFileProceeded||(this.positionHistory[this.positionHistory.length-1].end=t),this.paused=!0,this.stop(),this.lastPosition!==t?this.onPositionUpdated(t):n.g.d(A,"Ignoring player position "+t+", already proceeded...",this.handler.id),this.lastPosition=t,this.lastPositionBeforePause=this.lastPosition}onResume(){this.paused=!1,this.buffering||(this.lastPosition=this.playerAdapter.getPosition(),!1===this.firstFileProceeded&&this.positionHistory.push({start:this.lastPosition}),Math.abs(this.lastPosition-this.lastPositionBeforePause)<1e3&&(n.g.d(A,"Reverting position because of bad position when resuming...",this.handler.id),this.lastPosition=this.lastPositionBeforePause,this.lastPositionBeforePause=0),this.checkStart())}onBufferingStart(){const t=this.playerAdapter.getPosition();!1===this.buffering&&!1===this.firstFileProceeded&&(this.positionHistory[this.positionHistory.length-1].end=t),this.buffering=!0,this.stop(),this.lastPosition!==t?this.onPositionUpdated(t):n.g.d(A,"Ignoring player position "+t+", already proceeded...",this.handler.id),this.lastPosition=t}onBufferingEnd(t){if(this.buffering=!1,!this.paused){const t=this.playerAdapter.getPosition();!1===this.firstFileProceeded&&(this.positionHistory.length>0&&void 0===this.positionHistory[this.positionHistory.length-1].end&&(this.positionHistory[this.positionHistory.length-1].end=this.lastPosition),this.positionHistory.push({start:t})),this.lastPosition!==t&&(n.g.d(A,"Position updated during buffering, period switch ?",this.handler.id),this.onPositionUpdated(t)),Math.abs(this.lastPosition-this.lastPositionAfterSeek)<1e3&&(n.g.d(A,"Reverting position because of seek...",this.handler.id),this.lastPosition=this.lastPositionAfterSeek,this.lastPositionAfterSeek=0),this.checkStart()}}onSeek(t,i){let s;if(!1===this.firstFileProceeded&&!1===this.buffering&&(this.positionHistory[this.positionHistory.length-1].end=t,this.positionHistory.push({start:i})),t<this.lastPosition&&this.lastPosition-t<P.POSITION_SEEK_ERROR_DELTA&&(n.g.d(A,"Updating seek start position from "+t+" to "+this.lastPosition,this.handler.id),t=this.lastPosition),this.buffering?(this.lastPositionAfterSeek=i,s=this.lastPosition):(Math.abs(this.lastPosition-t)<P.POSITION_SEEK_ERROR_DELTA&&(this.onPositionUpdated(t),this.lastPosition=t),s=t,this.lastPositionAfterSeek=0),this.lastPosition=i,Math.abs(i-t)<P.POSITION_SEEK_ERROR_DELTA)if(i<t){if(t-i<2e3)return n.g.d(A,"Ignoring seek...",this.handler.id),this.lastPosition=t,void this.onPositionUpdated(t);n.g.d(A,"Reset ad trackers with position "+i,this.handler.id),this.adData?.resetProgression(i)}else{n.g.d(A,"Small seek detected, proceeding events from "+s+" to "+i,this.handler.id);for(let t=s;t<=i;t+=P.POSITION_UPDATE_INTERVAL){const s=Math.min(t+P.POSITION_UPDATE_INTERVAL,i);n.g.d(A,"Between "+t+" and "+s,this.handler.id),this.lastPosition=t,this.onPositionUpdated(s)}}else void 0!==this.currentAdTracker&&this.notifyAdSkipped(this.adData.sessionToken,this.currentAdTracker),this.onPositionUpdated(i),n.g.d(A,"Reset ad trackers with position "+i,this.handler.id),this.adData?.resetProgression(i)}onStop(t){this.stop(),this.lastPosition=this.playerAdapter.getPosition(),this.onPositionUpdated(this.lastPosition),this.stop(),void 0!==this.updateSessionJob&&o.A.getInstance().cancel(this.updateSessionJob),this.adPalSession?.sendPlaybackEnd()}addListener(t){void 0===t||this.listeners.includes(t)||this.listeners.push(t)}removeListener(t){let i=this.listeners.indexOf(t);-1!==i&&this.listeners.splice(i,1)}notifyEvent(t,i,s,e,a,r){"function"==typeof t[i]&&t[i](s,e,a,r)}notifyAdBreakData(t){this.listeners.forEach((i=>{this.notifyEvent(i,"onAdBreakData",t)}))}notifyAdBreakBegin(t){this.listeners.forEach((i=>{this.notifyEvent(i,"onAdBreakBegin",t)}))}notifyAdData(t){this.listeners.forEach((i=>{this.notifyEvent(i,"onAdData",t)}))}notifyAdBegin(t,i){this.listeners.forEach((s=>{this.notifyEvent(s,"onAdBegin",t,i.creativeId,i.adId)})),this.adPalSession?.sendAdImpression()}notifyAdSkippable(t){this.listeners.forEach((i=>{this.notifyEvent(i,"onAdSkippable",t)}))}notifyAdProgress(t,i,s){this.listeners.forEach((e=>{this.notifyEvent(e,"onAdProgress",t,i.creativeId,i.adId,s)}))}notifyAdSkipped(t,i){const s=[];i.adBreak.ads.forEach((t=>{t.position>i.position&&this.lastPosition>=t.position+t.duration&&s.push(t.adId)})),this.listeners.forEach((e=>{this.notifyEvent(e,"onAdSkipped",t,i.creativeId,i.adId,s)}))}notifyAdEnd(t,i){this.isLive()&&(void 0!==this.updateSessionJob&&o.A.getInstance().cancel(this.updateSessionJob),this.updateBkYouSession()),this.listeners.forEach((s=>{this.notifyEvent(s,"onAdEnd",t,i.creativeId,i.adId)}))}notifyAdBreakEnd(t){this.listeners.forEach((i=>{this.notifyEvent(i,"onAdBreakEnd",t)}))}notifyAdsUpdated(t){this.listeners.forEach((i=>{this.notifyEvent(i,"onAdsUpdated",t)}))}notifyAdDataListener(t){const i=this.firstImageDate||Date.now(),s=0===this.podsSentNumber&&!1===this.firstFileProceeded&&Date.now()-i<=P.POSITION_START_DELTA;n.g.d(A,"On ad data (firstData: "+s+", dataUpdated: "+t+")",this.handler.id),!0!==s&&!0!==t||(this.podsSentNumber=this.adList.length,n.g.d(A,"On ad data (length: "+this.podsSentNumber+")",this.handler.id),this.handler.adSession?.adDataListener?.onAdData(this.adList))}}const S="BpkAdMetricsMgr";class m{handler;timeline;builder;adMetrics;firstImageDate;lastLayerBitrate;adBreakPlaying;adPlaying;adSkipped;adLastLayerSwitchDate;adLastBufferingStartDate;adBreakPosition;constructor(t){this.handler=t,this.timeline=this.handler.sessionReport.timeline,this.builder=new r,this.adMetrics={}}onStart(){this.adMetrics={},this.adLastLayerSwitchDate=0,this.firstImageDate=0,this.lastLayerBitrate=0,this.adLastBufferingStartDate=-1,this.adBreakPlaying=!1,this.adPlaying=!1,this.adSkipped=!1,this.adBreakPosition="midroll"}onFirstImage(t,i){this.lastLayerBitrate=t,this.adLastLayerSwitchDate=Date.now(),this.firstImageDate=Date.now()}onLayerSwitch(t){this.adBreakPlaying&&this.firstImageDate>0&&(this.builder.addTimeSpentPerLayer(this.lastLayerBitrate,Date.now()-this.adLastLayerSwitchDate),this.adLastLayerSwitchDate=Date.now(),this.lastLayerBitrate!==t&&this.builder.addLayerSwitch()),this.lastLayerBitrate=t}onBufferingStart(){this.adBreakPlaying&&(this.adLastBufferingStartDate=Date.now())}onStallEnd(){this.adBreakPlaying&&this.adLastBufferingStartDate>=0&&this.builder.addStall(Date.now()-this.adLastBufferingStartDate),this.adLastBufferingStartDate=-1}onRebufferingEnd(){this.adLastBufferingStartDate=-1}onSeek(t,i){this.adBreakPlaying&&(n.g.d(S,"Ad seeked from "+e.A.formatTime(t)+" to "+e.A.formatTime(i),this.handler?.id),Math.abs(i-t)<P.POSITION_SEEK_ERROR_DELTA?n.g.d(S,"Ignoring seek < "+P.POSITION_SEEK_ERROR_DELTA+"ms",this.handler?.id):(n.g.d(S,"Ad skipped (above seek threshold)",this.handler?.id),this.adSkipped=!0))}onStop(t){this.adBreakPlaying&&(this.handleAdEnd(),this.adBreakPlaying=!1)}onAdBreakData(t){Math.abs(t.position+t.duration-this.handler.playerAdapter?.getDuration())<1e4?this.adBreakPosition="postroll":Date.now()-this.firstImageDate<P.POSITION_START_DELTA?this.adBreakPosition="preroll":this.adBreakPosition="midroll",n.g.d(S,"Ad break position is "+this.adBreakPosition,this.handler?.id),this.adBreakPlaying=!0,void 0!==this.timeline&&this.timeline.pushEvent(d.A.analyticsModule?.SessionTrackerEvents.AdBreakStart)}onAdData(t){this.builder.isInitialized()&&this.adSkipped&&this.handleAdEnd();const i=!0===t.adBreak.live?-1:t.adBreak.ads.length;this.builder.reset().import(this.adMetrics[t.adId]).setCreativeId(t.creativeId).setAdId(t.adId).init(this.adBreakPosition,t.index,i),this.adSkipped=!1,this.adLastLayerSwitchDate=Date.now(),this.adPlaying=!0}onAdSkippable(t){this.builder.setAdSkippable(!0)}onAdSkipped(t,i,s,e){if(this.adSkipped=!0,e.length>0){n.g.d(S,"Ad break skipped",this.handler?.id);let t=1;e.forEach((i=>{this.adMetrics[i].forEach((i=>{if(i.impressionDate<=0){i.adSkipped=!0,i.adProgress=0,i.impressionDate=Date.now();const s=this.builder.adMetrics;i.adIndex=s.adIndex+t,i.adCount=s.adCount,i.adFormat=s.adFormat,t++}}))}))}}onAdProgress(t,i,s,e){this.builder.addProgress(e),e>0&&void 0===this.builder.quartiles[e-25]&&(n.g.d(S,"Ad skipped (no previous progress)",this.handler?.id),this.adSkipped=!0)}onAdEnd(t,i,s){this.handleAdEnd(),this.adPlaying=!1}onAdBreakEnd(t){!0===this.adPlaying&&(this.builder.setAdSkipped(!0),this.handleAdEnd()),this.adBreakPlaying=!1,void 0!==this.timeline&&this.timeline.pushEventProgress(d.A.analyticsModule?.SessionTrackerEvents.AdBreakStop,0)}onKeepaliveSessionReportUpdateRequested(t){if(this.adBreakPlaying){const t=this.builder.clone().addTimeSpentPerLayer(this.lastLayerBitrate,Date.now()-this.adLastLayerSwitchDate);this.adLastBufferingStartDate>=0&&t.addStall(Date.now()-this.adLastBufferingStartDate);const i=t.build();i.adId.length>0&&this.storeMetrics(i)}t.adMetrics=this.generateMetrics()}onEndSessionReportUpdateRequested(t){t.adMetrics=this.generateMetrics()}storeMetrics(t){const i=t.adId;void 0===this.adMetrics[i]&&(this.adMetrics[i]=[]);const s=this.adMetrics[i].findIndex((i=>i.impressionDate===t.impressionDate));-1===s?this.adMetrics[i].push(t):this.adMetrics[i][s]=t}generateMetrics(){let t=[];return Object.values(this.adMetrics).forEach((i=>{i.forEach((i=>t.push(i)))})),t}handleAdEnd(){this.builder.setAdSkipped(this.adSkipped).addTimeSpentPerLayer(this.lastLayerBitrate,Date.now()-this.adLastLayerSwitchDate);const t=this.builder.build();t.adId.length>0&&this.storeMetrics(t),n.g.d(S,"Ad metrics : "+t.toString(),this.handler?.id),this.builder.reset(),this.adSkipped=!1}onAdsUpdated(t){t.adBreaks.forEach((t=>{t.ads.forEach((t=>{if(void 0===this.adMetrics[t.adId]){const i=(new r).setCreativeId(t.creativeId).setAdId(t.adId).build();this.adMetrics[t.adId]=[i],n.g.d(S,"Adding ad metrics report for ad id "+t.adId,this.handler?.id)}}))}))}}var D=s(1105),v=s(5305);const E="BpkOMSDKMgr";class y{static#t;smartLib;static getInstance(){return y.#t||(y.#t=new y),y.#t}constructor(){}init(){n.g.d(E,"Initializing OM SDK manager...")}release(){}attachInstance(t){this.smartLib=t}attachHandler(t){n.g.d(E,"Attaching OM SDK handler..."),this.omsdkHandler=t}isEnabled(){return void 0!==this.omsdkHandler&&null!==this.omsdkHandler}}const b="BpkOMSessionHandler";class I{handler;adSession;playerAdapter;internalAdManager;omsdkHandler;omAdSession;firstImageDate;adBreakPosition;pause;buffering;constructor(t,i){this.handler=t,this.adSession=t.adSession,this.playerAdapter=i,this.internalAdManager=this.handler.smartLib.internalAdManager,this.omsdkHandler=y.getInstance().omsdkHandler,this.firstImageDate=0,this.adBreakPosition="midroll",this.pause=!1,this.buffering=!1}onStart(){}onRedirectionEnd(){}onFirstImage(t,i){this.firstImageDate=Date.now()}onLayerSwitch(t){}onPause(){!1===this.pause&&this.omAdSession?.pause(),this.pause=!0}onResume(){!0===this.pause&&this.omAdSession?.resume(),this.pause=!1}onBufferingStart(){!1===this.buffering&&this.omAdSession?.bufferStart(),this.buffering=!0}onBufferingEnd(t){!0===this.buffering&&this.omAdSession?.bufferFinish(),this.buffering=!1}onStallEnd(){}onRebufferingEnd(){}onSeek(t,i){void 0!==this.adData&&Math.abs(i-t)>=1e3&&(i>=this.adData.position+this.adData.duration||i<this.adData.position)&&this.omAdSession?.skipped()}onStop(t){this.adData=void 0,void 0!==this.omAdSession&&(this.omAdSession.finish(),this.omAdSession=void 0),this.adBreakPosition="midroll"}onStartSessionReportUpdateRequested(t){}onKeepaliveSessionReportUpdateRequested(t){}onEndSessionReportUpdateRequested(t){}onAdBreakData(t){Math.abs(t.position+t.duration-this.playerAdapter.getDuration())<1e4?this.adBreakPosition="postroll":Date.now()-this.firstImageDate<P.POSITION_START_DELTA?this.adBreakPosition="preroll":this.adBreakPosition="midroll",n.g.d(b,"Ad break position is "+this.adBreakPosition,this.handler.id)}onPrepareAdBreak(t){}onAdBreakBegin(t){}startAdSession(t,i){this.omAdSession=t,void 0!==this.adSession?.adView&&this.omAdSession.setAdView(this.adSession.adView),this.adSession?.adFriendlyObstructionViews.length>0&&this.adSession.adFriendlyObstructionViews.forEach((t=>{this.omAdSession.registerAdFriendlyObstructionView(t.view,t.purpose,t.reason)})),this.omAdSession.start(),void 0!==this.adSession?.adViewState&&this.omAdSession.setAdViewState(this.adSession.adViewState),!0===i.skippable?this.omAdSession.loaded(i.skippablePosition-i.position,i.duration,this.adBreakPosition,this.playerAdapter.getVolume()):this.omAdSession.loaded(-1,i.duration,this.adBreakPosition,this.playerAdapter.getVolume()),n.g.d(b,"OM ad session loaded",this.handler.id)}onAdData(t){let i;void 0!==this.adData&&(this.omAdSession?.finish(),this.omAdSession=void 0),this.adData=t,i=void 0!==this.adSession?.adVerificationData?[...this.adSession.adVerificationData]:[],this.adData.verifications.forEach((t=>{const s=t.javascriptResources.find((t=>"omid"===t.apiframework));i.push({verificationVendor:t.vendor,verificationURL:s.url,verificationParameters:t.verificationParameters})}));const s=this.omsdkHandler.createOMAdSession(this.internalAdManager.omPartnerName,this.internalAdManager.omPartnerVersion,this.adSession?.adCustomReference,i,(i=>{this.startAdSession(i,t)}));void 0!==s&&this.startAdSession(s,t)}onPrepareAd(t,i,s){}onAdBegin(t,i,s){}onAdSkippable(t){}onAdProgress(t,i,s,e){this.omAdSession?.progress(e)}onAdEnd(t,i,s){this.adData=void 0,this.omAdSession?.finish(),this.omAdSession=void 0}onAdBreakEnd(t){this.adData=void 0,void 0!==this.omAdSession&&(this.omAdSession.finish(),this.omAdSession=void 0),this.adBreakPosition="midroll"}onVolumeChanged(t){n.g.d(b,"Volume is now "+t,this.handler.id),this.omAdSession?.volumeChange(t)}onPlayerError(t,i){n.g.e(b,"Broadpeak status code "+t,this.handler.id),n.g.e(b,"Player error code "+i,this.handler.id),this.omAdSession?.error(t,i)}}d.A.adModule={AdMetrics:a,AdMetricsBuilder:r,AdMetricsManager:m,AdTrackingManager:P,AdDataTracker:l,AdBreakTracker:u,AdTracker:g,AdEventTracker:k,AdManager:f.X2,AdViewState:f.up,AdFriendlyObstructionPurpose:f.D6,AdType:f.eQ,AdSession:D.A,InternalAdManager:v.A,OMSDKManager:y,OMSessionHandler:I}}},function(t){return t.O(0,[153],(function(){return i=7575,t(t.s=i);var i})),t.O()}])}));